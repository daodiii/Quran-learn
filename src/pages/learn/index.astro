---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Container from '../../components/primitives/Container.astro';
import CourseCard from '../../components/cards/CourseCard.astro';
import LessonCard from '../../components/cards/LessonCard.astro';
import CardGrid from '../../components/cards/CardGrid.astro';
import { getCollection } from 'astro:content';

const allLessons = await getCollection('lessons');

const levelNames: Record<number, { title: string; titleAr: string; desc: string }> = {
  1: { title: 'Foundation', titleAr: 'الأساسيات', desc: 'Build your foundation in Arabic: alphabet, vowels, basic word structures, and sentence types.' },
  2: { title: 'Core Grammar', titleAr: 'القواعد الأساسية', desc: 'Master the essential grammar: I\'rab cases (Marfu\', Mansub, Majrur), Idafah, and sentence analysis.' },
  3: { title: 'Intermediate', titleAr: 'القواعد المتوسطة', desc: 'Verb forms I through X, full conjugations, Inna & Kaana sisters, and passive voice.' },
  4: { title: 'Advanced', titleAr: 'القواعد المتقدمة', desc: 'Complex grammatical constructions: conditionals, exceptions, Maf\'ul types, and rhetorical structures.' },
  5: { title: 'Applied Study', titleAr: 'التطبيق القرآني', desc: 'Apply everything to the Quran: pattern recognition, vocabulary, and full verse analysis.' },
};

const levels: (1 | 2 | 3 | 4 | 5)[] = [1, 2, 3, 4, 5];

const courseSchema = {
  "@context": "https://schema.org",
  "@type": "Course",
  "name": "Quranic Arabic Grammar",
  "description": "A structured course for learning Quranic Arabic grammar from beginner to advanced, covering 73 lessons across 5 levels.",
  "provider": {
    "@type": "Organization",
    "name": "Quranic Grammar",
    "url": "https://quranic-grammar.com/",
  },
  "numberOfCredits": 0,
  "isAccessibleForFree": true,
  "inLanguage": "en",
  "hasCourseInstance": levels.map(level => ({
    "@type": "CourseInstance",
    "name": `Level ${level}: ${levelNames[level].title}`,
    "description": levelNames[level].desc,
    "courseMode": "online",
  })),
};
---

<BaseLayout title="Grammar Lessons" description="Browse all 73 Quranic Arabic grammar lessons across 5 levels. From the Arabic alphabet and vowels to verb forms I-X, I'rab case endings, and applied Quranic analysis.">
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(courseSchema)} />
  </Fragment>
  <Container maxWidth="xl">
    <header class="page-header">
      <h1 class="page-title">Grammar Curriculum</h1>
      <p class="page-subtitle">73 lessons across 5 levels, from the Arabic alphabet to full Quranic analysis.</p>
    </header>

    <!-- Level Overview Cards -->
    <CardGrid minCardWidth={280} gap="md">
      {levels.map(level => {
        const info = levelNames[level];
        const lessons = allLessons
          .filter(l => l.data.level === level)
          .sort((a, b) => a.data.order - b.data.order);

        return (
          <CourseCard
            title={info.title}
            level={level}
            lessonsCompleted={0}
            totalLessons={lessons.length}
            href={`#level-${level}`}
            data-level={level}
          >
            <p class="level-arabic" dir="rtl" lang="ar">{info.titleAr}</p>
            <p>{info.desc}</p>
          </CourseCard>
        );
      })}
    </CardGrid>

    <!-- Level Sections with Lesson Lists -->
    {levels.map(level => {
      const info = levelNames[level];
      const lessons = allLessons
        .filter(l => l.data.level === level)
        .sort((a, b) => a.data.order - b.data.order);

      return (
        <section id={`level-${level}`} class="level-section" data-level={level}>
          <div class="level-header">
            <h2 class="level-title">
              <span class="level-number">Level {level}</span>
              {info.title}
            </h2>
            <span class="level-arabic" dir="rtl" lang="ar">{info.titleAr}</span>
          </div>

          {level === 1 && lessons.length > 0 ? (
            <>
              {/* Essential lessons (1-5) with green accent */}
              <div class="lessons-grid">
                {lessons.slice(0, 5).map(lesson => (
                  <LessonCard
                    title={lesson.data.title}
                    level={level}
                    completed={false}
                    href={`/learn/${lesson.id}/`}
                    data-lesson-id={lesson.id}
                    class="lesson-essential"
                  >
                    {lesson.data.description}
                  </LessonCard>
                ))}
              </div>

              {/* Mandatory banner */}
              <div class="mandatory-banner">
                <svg class="mandatory-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                  <path d="m9 12 2 2 4-4"/>
                </svg>
                <p class="mandatory-text">Mandatory to know if you want to benefit from this course. Skip these if you already know how to read Arabic.</p>
              </div>

              {/* Remaining lessons (6-11) */}
              <div class="lessons-grid">
                {lessons.slice(5).map(lesson => (
                  <LessonCard
                    title={lesson.data.title}
                    level={level}
                    completed={false}
                    href={`/learn/${lesson.id}/`}
                    data-lesson-id={lesson.id}
                  >
                    {lesson.data.description}
                  </LessonCard>
                ))}
              </div>
            </>
          ) : lessons.length > 0 ? (
            <div class="lessons-grid">
              {lessons.map(lesson => (
                <LessonCard
                  title={lesson.data.title}
                  level={level}
                  completed={false}
                  href={`/learn/${lesson.id}/`}
                  data-lesson-id={lesson.id}
                >
                  {lesson.data.description}
                </LessonCard>
              ))}
            </div>
          ) : (
            <p class="no-lessons">Lessons coming soon.</p>
          )}
        </section>
      );
    })}
  </Container>
</BaseLayout>

<style>
  .page-header {
    padding-block-start: var(--spacing-2xl);
    padding-block-end: var(--spacing-xl);
    text-align: center;
  }

  .page-title {
    font-family: var(--font-display);
    font-size: clamp(2rem, 5vw, 3rem);
    font-weight: 700;
    color: var(--color-text-primary);
    margin-block-end: var(--spacing-sm);
    letter-spacing: -0.03em;
    line-height: 1.1;
  }

  .page-subtitle {
    font-size: clamp(1rem, 2vw, 1.125rem);
    color: var(--color-text-secondary);
    max-inline-size: 48rem;
    margin-inline: auto;
  }

  /* Level Arabic in CourseCard */
  .level-arabic {
    font-family: 'Amiri', serif;
    font-size: 1.125rem;
    color: var(--color-text-secondary);
    margin-block-end: var(--spacing-xs);
    line-height: 1.6;
  }

  /* Level Section */
  .level-section {
    margin-block-start: var(--spacing-3xl);
    scroll-margin-block-start: 5rem;
  }

  .level-header {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
    margin-block-end: var(--spacing-lg);
    padding-block-end: var(--spacing-md);
    border-block-end: 3px solid var(--accent-gold);
  }

  .level-title {
    font-family: var(--font-display);
    font-size: clamp(1.5rem, 3vw, 2rem);
    font-weight: 700;
    color: var(--color-text-primary);
    display: flex;
    align-items: baseline;
    gap: var(--spacing-sm);
    flex-wrap: wrap;
    letter-spacing: -0.02em;
  }

  .level-number {
    font-family: var(--font-display);
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--accent-gold);
  }

  .level-header .level-arabic {
    font-family: 'Amiri', serif;
    font-size: 1.25rem;
    color: var(--accent-gold);
  }

  /* Lessons Grid */
  .lessons-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(100%, 320px), 1fr));
    gap: var(--spacing-md);
  }

  @media (min-width: 768px) {
    .lessons-grid {
      grid-template-columns: repeat(auto-fill, minmax(min(100%, 360px), 1fr));
    }
  }

  /* Essential lesson cards - green accent */
  .lessons-grid :global(.lesson-essential .card) {
    border-left: 4px solid var(--accent-primary);
    background: var(--accent-primary-light);
  }

  :global([data-theme="dark"]) .lessons-grid :global(.lesson-essential .card) {
    border-left-color: var(--accent-primary);
    background: var(--accent-primary-light);
  }

  .lessons-grid :global(.lesson-essential .card:hover) {
    border-left-color: var(--accent-primary);
  }

  /* Mandatory banner */
  .mandatory-banner {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-md) var(--spacing-lg);
    margin-block: var(--spacing-xl);
    background: var(--accent-primary-light);
    border: 1px solid var(--accent-primary);
    border-radius: var(--radius-lg);
  }

  .mandatory-icon {
    color: var(--accent-primary);
    flex-shrink: 0;
  }

  .mandatory-text {
    margin: 0;
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--accent-primary);
  }

  :global([data-theme="dark"]) .mandatory-banner {
    background: var(--accent-primary-light);
    border-color: var(--accent-primary);
  }

  .no-lessons {
    font-size: 0.875rem;
    color: var(--color-text-tertiary);
    font-style: italic;
    padding: var(--spacing-lg);
    text-align: center;
  }

  /* Completed lesson styling */
  .lessons-grid :global([data-lesson-id].completed) {
    opacity: 0.8;
  }
</style>

<script>
  import { getCompletedLessons } from '../../lib/progress';

  // Populate lesson completion states from localStorage
  // Run immediately — module scripts are deferred and execute after DOM is parsed
  const completedLessons = getCompletedLessons();

  // Update LessonCard completion states
  const lessonCards = document.querySelectorAll('[data-lesson-id]');
  lessonCards.forEach(card => {
    const lessonId = card.getAttribute('data-lesson-id');
    if (completedLessons.includes(lessonId!)) {
      card.classList.add('completed');

      // Replace checkmark SVG with completed version
      const checkmarkCircle = card.querySelector('.checkmark-circle');
      if (checkmarkCircle) {
        checkmarkCircle.classList.remove('incomplete');
        checkmarkCircle.classList.add('completed');
        const svg = checkmarkCircle.querySelector('svg');
        if (svg) {
          svg.innerHTML = `
            <circle cx="12" cy="12" r="11" fill="var(--color-accent-primary)"/>
            <path d="M7 12l3 3 7-7" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          `;
        }
      }
    }
  });

  // Calculate level progress and update overview cards
  const levelOverviews = document.querySelectorAll('[data-level]');
  levelOverviews.forEach(card => {
    const levelAttr = card.getAttribute('data-level');
    if (!levelAttr) return;

    const level = parseInt(levelAttr, 10);

    // Find all lessons for this level
    const levelLessonCards = Array.from(document.querySelectorAll('[data-lesson-id]')).filter(lessonCard => {
      const lessonId = lessonCard.getAttribute('data-lesson-id');
      return lessonId && lessonId.startsWith(`level-${level}/`);
    });

    const completed = levelLessonCards.filter(l => l.classList.contains('completed')).length;
    const total = levelLessonCards.length;

    // Update progress bar if present in the overview card
    const progressBar = card.querySelector('[role="progressbar"]');
    if (progressBar && total > 0) {
      progressBar.setAttribute('aria-valuenow', String(completed));

      const fill = progressBar.querySelector('.progress-fill');
      if (fill) {
        (fill as HTMLElement).style.inlineSize = `${(completed / total) * 100}%`;
      }
    }

    // Update lessons completed text if present
    const progressText = card.querySelector('.course-card-progress-text');
    if (progressText) {
      progressText.textContent = `${completed} of ${total} lessons`;
    }
  });
</script>
