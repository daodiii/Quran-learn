---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import AriaLiveRegion from '../components/AriaLiveRegion.astro';

interface Props {
  title: string;
  description?: string;
  image?: string;
  type?: 'website' | 'article';
}

const {
  title,
  description = 'Learn Quranic Arabic grammar from beginner to advanced. Comprehensive lessons, verb forms, and detailed surah breakdowns.',
  image = '/images/og-default.jpg',
  type = 'website',
} = Astro.props;

const siteName = 'Quranic Grammar';
const fullTitle = `${title} | ${siteName}`;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const ogImageURL = new URL(image, Astro.site);
---

<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <!-- Google Analytics (GA4) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1MSBYYQT5Z" is:inline></script>
  <script is:inline>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-1MSBYYQT5Z');
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="description" content={description} />
  <meta name="theme-color" content="#1A1147" media="(prefers-color-scheme: light)" />
  <meta name="theme-color" content="#1A1614" media="(prefers-color-scheme: dark)" />
  <title>{fullTitle}</title>
  <!-- Canonical URL -->
  <link rel="canonical" href={canonicalURL.href} />
  <!-- Open Graph -->
  <meta property="og:type" content={type} />
  <meta property="og:url" content={canonicalURL.href} />
  <meta property="og:title" content={fullTitle} />
  <meta property="og:description" content={description} />
  <meta property="og:image" content={ogImageURL.href} />
  <meta property="og:site_name" content={siteName} />
  <meta property="og:locale" content="en_US" />
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content={fullTitle} />
  <meta name="twitter:description" content={description} />
  <meta name="twitter:image" content={ogImageURL.href} />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <!-- Preload critical Arabic fonts -->
  <link rel="preload" href="/fonts/amiri-regular-arabic.woff2" as="font" type="font/woff2" crossorigin />
  <link rel="preload" href="/fonts/UthmanicHafs.woff2" as="font" type="font/woff2" crossorigin />
  <!-- Prevent flash of wrong theme -->
  <script is:inline>
    (function() {
      const theme = localStorage.getItem('theme') ||
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <slot name="head" />
</head>
<body class="min-h-screen flex flex-col font-sans">
  <!-- Skip link for keyboard navigation -->
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <slot name="before-header" />
  <Header />
  <main id="main-content" class="flex-1">
    <slot />
  </main>
  <Footer />
  <AriaLiveRegion />
  <script>
    import { initCapacitor } from '../scripts/capacitor-init';
    import { initNavigation } from '../scripts/navigation';

    initCapacitor();

    // Theme toggle functionality
    function initTheme() {
      const themeToggle = document.getElementById('theme-toggle');
      const html = document.documentElement;

      function setTheme(theme: string) {
        html.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);

        // Update meta theme-color
        const metaTheme = document.querySelector('meta[name="theme-color"]');
        if (metaTheme) {
          metaTheme.setAttribute('content', theme === 'dark' ? '#1A1614' : '#1A1147');
        }
      }

      function toggleTheme() {
        const currentTheme = html.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
      }

      themeToggle?.addEventListener('click', toggleTheme);

      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem('theme')) {
          setTheme(e.matches ? 'dark' : 'light');
        }
      });
    }

    initTheme();

    // Initialize navigation on initial load
    initNavigation();

    // Re-initialize navigation on Astro view transitions (if enabled)
    document.addEventListener('astro:page-load', () => {
      initNavigation();
    });

    document.querySelectorAll('.expandable-header').forEach(header => {
      header.addEventListener('click', () => {
        const content = header.nextElementSibling;
        const arrow = header.querySelector('.expand-arrow');
        if (content) {
          content.classList.toggle('open');
        }
        if (arrow) {
          arrow.classList.toggle('rotate-180');
        }
      });
    });
  </script>
</body>
</html>
