---
import BaseLayout from './BaseLayout.astro';

import CourseNavigator from '../components/navigation/CourseNavigator.astro';
import NavigatorToggle from '../components/navigation/NavigatorToggle.astro';
import Breadcrumbs from '../components/navigation/Breadcrumbs.astro';
import { getCollection } from 'astro:content';

interface Props {
  title: string;
  titleArabic?: string;
  level: number;
  description?: string;
  nextLesson?: string;
  prevLesson?: string;
}

const { title, titleArabic, level, description, nextLesson, prevLesson } = Astro.props;

// Get the lesson slug from the URL path
const lessonSlug = Astro.url.pathname.replace(/^\/learn\//, '').replace(/\/$/, '');

// Find the current lesson entry to get its full ID for CourseNavigator
const allLessons = await getCollection('lessons');
const currentLesson = allLessons.find(lesson => {
  const lessonPath = `/learn/${lesson.id.replace('.mdx', '')}/`;
  return lessonPath === Astro.url.pathname || lessonPath === Astro.url.pathname + '/';
});

const currentLessonSlug = currentLesson?.id || '';

// Build breadcrumb items
const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: 'Learn', href: '/learn/' },
  { label: `Level ${level}`, href: `/learn/#level-${level}` },
  { label: title }
];

const levelNames: Record<number, string> = {
  1: 'Foundation',
  2: 'Core Grammar',
  3: 'Intermediate',
  4: 'Advanced',
  5: 'Applied Study',
};
---

<BaseLayout title={title} description={description} type="article">
  <!-- Backdrop for mobile sidebar -->
  <div id="navigator-backdrop" class="navigator-backdrop"></div>

  <div class="lesson-page">
    <div class="lesson-grid">
      <!-- Sidebar with CourseNavigator -->
      <aside class="lesson-sidebar">
        <CourseNavigator currentLessonSlug={currentLessonSlug} />
      </aside>

      <!-- Main Content -->
      <main class="lesson-main">
        <!-- Breadcrumbs -->
        <Breadcrumbs items={breadcrumbItems} />

        <article class="lesson-article">
        <header class="lesson-header">
          <span class={`level-badge level-badge-${level}`}>Level {level}</span>
          <h1 class="lesson-title">{title}</h1>
          {titleArabic && (
            <p class="lesson-arabic">{titleArabic}</p>
          )}
          {description && (
            <p class="lesson-description">{description}</p>
          )}
        </header>

        <div class="lesson-content">
          <slot />
        </div>

        <!-- Mark Complete Button -->
        <div class="complete-section" id="complete-section" data-lesson-slug={lessonSlug}>
          <button id="complete-btn" class="complete-btn">
            <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
            </svg>
            <span id="complete-btn-text">Mark as Complete</span>
          </button>
          <p id="complete-status" class="complete-status" style="display: none;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
            </svg>
            Completed
          </p>
        </div>

        <!-- Previous/Next Navigation -->
        <nav class="lesson-nav">
          {prevLesson ? (
            <a href={prevLesson} class="nav-link prev">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
              Previous Lesson
            </a>
          ) : <div></div>}
          {nextLesson ? (
            <a href={nextLesson} class="nav-link next">
              Next Lesson
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </a>
          ) : <div></div>}
        </nav>
      </article>
      </main>
    </div>
  </div>

  <!-- Floating toggle for mobile -->
  <NavigatorToggle variant="floating" />
</BaseLayout>

<style>
  /* Backdrop for mobile sidebar */
  .navigator-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 39;
    opacity: 0;
    pointer-events: none;
    transition: opacity 300ms ease;
  }

  .navigator-backdrop.visible {
    opacity: 1;
    pointer-events: auto;
  }

  .lesson-page {
    max-width: 80rem;
    margin: 0 auto;
    padding: 0;
  }

  /* Grid Layout */
  .lesson-grid {
    display: flex;
    flex-direction: column;
    min-block-size: 100vh;
  }

  @media (min-width: 1024px) {
    .lesson-grid {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 0;
    }
  }

  /* Sidebar: use display:contents on mobile so the fixed-position
     CourseNavigator can render (display:none would prevent it) */
  .lesson-sidebar {
    display: contents;
  }

  @media (min-width: 1024px) {
    .lesson-sidebar {
      display: block;
      position: sticky;
      top: 0;
      block-size: 100vh;
      overflow-y: auto;
    }
  }

  /* Main content area */
  .lesson-main {
    min-inline-size: 0;
    padding: 2rem 1rem;
  }

  @media (min-width: 640px) {
    .lesson-main {
      padding: 2rem 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .lesson-main {
      padding: 2rem 3rem;
    }
  }

  /* Article */
  .lesson-article {
    min-width: 0;
    max-inline-size: 70ch;
    margin-inline: auto;
  }

  .lesson-header {
    margin-bottom: 2rem;
  }

  .level-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.625rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    border-radius: var(--radius-md);
  }

  .level-badge-1 { background: var(--level-1-bg); color: var(--level-1-text); }
  .level-badge-2 { background: var(--level-2-bg); color: var(--level-2-text); }
  .level-badge-3 { background: var(--level-3-bg); color: var(--level-3-text); }
  .level-badge-4 { background: var(--level-4-bg); color: var(--level-4-text); }
  .level-badge-5 { background: var(--level-5-bg); color: var(--level-5-text); }

  .lesson-title {
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-top: 0.75rem;
    letter-spacing: -0.02em;
  }

  @media (min-width: 640px) {
    .lesson-title {
      font-size: 2.25rem;
    }
  }

  .lesson-arabic {
    font-family: var(--font-arabic);
    font-size: 1.25rem;
    color: var(--accent-primary);
    direction: rtl;
    margin-top: 0.5rem;
    line-height: 2;
  }

  .lesson-description {
    font-size: 1.0625rem;
    color: var(--text-secondary);
    margin-top: 0.75rem;
    line-height: 1.6;
  }

  /* Content Styles */
  .lesson-content {
    color: var(--text-primary);
    font-size: 1.0625rem; /* 17px */
    line-height: 1.75;
  }

  .lesson-content :global(h2) {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-primary);
  }

  .lesson-content :global(h3) {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .lesson-content :global(p) {
    color: var(--text-secondary);
    margin-bottom: 1rem;
  }

  .lesson-content :global(a) {
    color: var(--accent-primary);
    text-decoration: none;
  }

  .lesson-content :global(a:hover) {
    text-decoration: underline;
  }

  .lesson-content :global(strong) {
    color: var(--text-primary);
    font-weight: 600;
  }

  .lesson-content :global(ul),
  .lesson-content :global(ol) {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }

  .lesson-content :global(li) {
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
  }

  .lesson-content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    border-radius: var(--radius-lg);
    overflow: hidden;
    border: 1px solid var(--border-primary);
  }

  .lesson-content :global(th) {
    background: var(--accent-primary-light);
    color: var(--accent-primary);
    font-weight: 600;
    text-align: left;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-primary);
  }

  .lesson-content :global(td) {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-primary);
    background: var(--bg-elevated);
  }

  .lesson-content :global(tr:last-child td) {
    border-bottom: none;
  }

  .lesson-content :global(code) {
    background: var(--bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
    color: var(--accent-primary);
  }

  .lesson-content :global(pre) {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    padding: 1rem;
    overflow-x: auto;
    margin: 1.5rem 0;
  }

  .lesson-content :global(pre code) {
    background: transparent;
    padding: 0;
  }

  .lesson-content :global(blockquote) {
    border-left: 3px solid var(--accent-primary);
    padding-left: 1rem;
    margin: 1.5rem 0;
    color: var(--text-secondary);
    font-style: italic;
  }

  /* Navigation */
  .lesson-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-primary);
  }

  .nav-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--accent-primary);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .nav-link:hover {
    opacity: 0.8;
  }

  .nav-link svg {
    width: 18px;
    height: 18px;
    transition: transform var(--transition-fast);
  }

  .nav-link.prev:hover svg {
    transform: translateX(-2px);
  }

  .nav-link.next:hover svg {
    transform: translateX(2px);
  }

  /* Complete Section */
  .complete-section {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 2rem;
    padding: 1.5rem;
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
  }

  .complete-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: var(--accent-primary);
    color: white;
    font-size: 0.9375rem;
    font-weight: 600;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .complete-btn:hover {
    background: var(--accent-primary-hover);
  }

  .complete-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .complete-btn svg {
    width: 18px;
    height: 18px;
  }

  .complete-btn.completed {
    background: #059669;
  }

  .complete-status {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: #ecfdf5;
    color: #065f46;
    font-size: 0.9375rem;
    font-weight: 600;
    border-radius: var(--radius-md);
  }

  :global([data-theme="dark"]) .complete-status {
    background: #052e16;
    color: #6ee7b7;
  }

  .complete-status svg {
    width: 18px;
    height: 18px;
  }
</style>

<script>
  import { markLessonComplete, isLessonComplete } from '../lib/progress';

  async function initCompleteButton() {
    const section = document.getElementById('complete-section');
    const btn = document.getElementById('complete-btn') as HTMLButtonElement;
    const btnText = document.getElementById('complete-btn-text');
    const status = document.getElementById('complete-status');

    if (!section || !btn || !btnText || !status) return;

    const lessonSlug = section.dataset.lessonSlug || '';

    // Check if already completed
    const completed = await isLessonComplete(lessonSlug);
    if (completed) {
      btn.style.display = 'none';
      status.style.display = 'inline-flex';
      return;
    }

    // Handle click
    btn.addEventListener('click', async () => {
      btn.disabled = true;
      btnText.textContent = 'Saving...';

      const success = await markLessonComplete(lessonSlug);

      if (success) {
        btn.style.display = 'none';
        status.style.display = 'inline-flex';
      } else {
        btn.disabled = false;
        btnText.textContent = 'Mark as Complete';
      }
    });
  }

  initCompleteButton();
</script>
