---
/**
 * ArabicExample - Display Quranic verses with transliteration and translation
 *
 * Usage example (basic):
 * <ArabicExample
 *   arabic="بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ"
 *   transliteration="bismi llahi r-rahmani r-rahim"
 *   translation="In the name of God, the Most Gracious, the Most Merciful"
 *   reference="Surah Al-Fatiha 1:1"
 *   highlight="بِسْمِ"
 * />
 *
 * Usage example (with interlinear word-by-word):
 * <ArabicExample
 *   arabic="بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ"
 *   transliteration="bismi llahi r-rahmani r-rahim"
 *   translation="In the name of God, the Most Gracious, the Most Merciful"
 *   reference="Surah Al-Fatiha 1:1"
 *   words={[
 *     { ar: "بِسْمِ", tr: "bismi", en: "In the name of" },
 *     { ar: "اللَّهِ", tr: "Allāhi", en: "Allah" },
 *     { ar: "الرَّحْمَنِ", tr: "ar-raḥmāni", en: "the Most Gracious" },
 *     { ar: "الرَّحِيمِ", tr: "ar-raḥīmi", en: "the Most Merciful" },
 *   ]}
 * />
 */

interface WordEntry {
  ar: string;   // Arabic word (vocalized)
  tr: string;   // Transliteration
  en: string;   // English meaning
}

interface Props {
  arabic: string;           // Arabic text (fully vocalized with harakat)
  transliteration?: string; // Romanized pronunciation
  translation: string;      // English meaning
  reference?: string;       // Quranic reference (e.g., "Surah Al-Fatiha 1:2")
  highlight?: string;       // Comma-separated Arabic words to visually highlight
  words?: WordEntry[];      // Optional word-by-word interlinear data
}

const { arabic, transliteration, translation, reference, highlight, words } = Astro.props;

// Process highlight if provided
const highlightWords = highlight ? highlight.split(',').map(w => w.trim()) : [];

// Function to wrap highlighted words
const processArabicText = (text: string, words: string[]): string => {
  if (words.length === 0) return text;

  // Split by spaces and wrap matching words
  const parts = text.split(' ');
  return parts.map(part => {
    if (words.includes(part)) {
      return `<mark class="grammar-highlight">${part}</mark>`;
    }
    return part;
  }).join(' ');
};

const processedArabic = processArabicText(arabic, highlightWords);
const hasWords = words && words.length > 0;
---

<div class="arabic-example">
  {hasWords ? (
    <div class="interlinear" dir="rtl" aria-label={arabic}>
      {words.map((word) => {
        const isHighlighted = highlightWords.includes(word.ar);
        return (
          <div class:list={["word-unit", { highlighted: isHighlighted }]}>
            <span class="word-ar" lang="ar">{word.ar}</span>
            <span class="word-en" dir="ltr">{word.en}</span>
          </div>
        );
      })}
    </div>
  ) : (
    <p class="arabic-text" dir="rtl" lang="ar" set:html={processedArabic} />
  )}

  <p class="translation" dir="ltr">{translation}</p>

  {reference && (
    <p class="reference" dir="ltr">&mdash; {reference}</p>
  )}
</div>

<style>
  .arabic-example {
    background: var(--color-background-elevated);
    border: 1px solid var(--color-border-primary);
    border-left: 5px solid transparent;
    border-image: linear-gradient(180deg, #B8860B 0%, #D4A849 50%, #F2D98C 100%) 1;
    border-image-slice: 0 0 0 5;
    border-radius: var(--radius-xl);
    padding: var(--spacing-md) var(--spacing-lg);
    margin-block: var(--spacing-lg);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    box-shadow: var(--shadow-elevated);
  }

  :global([data-theme="dark"]) .arabic-example {
    background: var(--bg-elevated);
    border-image: linear-gradient(180deg, #F2D98C 0%, #FFE8A8 100%) 1;
    border-image-slice: 0 0 0 5;
    box-shadow: var(--shadow-md);
  }

  /* === Existing plain text display === */
  .arabic-text {
    font-family: var(--font-arabic);
    font-size: 1.5rem;
    line-height: 2;
    letter-spacing: 0;
    color: var(--color-text-primary);
    margin: 0;
    text-align: end;
  }

  @media (min-width: 640px) {
    .arabic-text {
      font-size: 1.75rem;
    }
  }

  .arabic-text :global(mark.grammar-highlight) {
    background: var(--accent-gold-light);
    color: var(--accent-gold);
    border-bottom: 2px solid var(--accent-gold);
    border-radius: var(--radius-sm);
    padding-inline: 0.25rem;
  }

  :global([data-theme="dark"]) .arabic-text :global(mark.grammar-highlight) {
    background: rgba(242, 217, 140, 0.15);
  }

  /* === Interlinear word-by-word layout === */
  .interlinear {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs) var(--spacing-sm);
    justify-content: flex-start;
    padding-block-end: var(--spacing-sm);
    border-block-end: 1px solid var(--color-border-primary);
    margin-block-end: 0;
  }

  .word-unit {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-md);
    transition: background-color 0.15s ease;
    min-inline-size: 2.5rem;
  }

  .word-unit:hover {
    background-color: var(--accent-gold-light);
  }

  :global([data-theme="dark"]) .word-unit:hover {
    background-color: rgba(242, 217, 140, 0.1);
  }

  .word-unit.highlighted {
    background-color: var(--accent-gold-light);
    border-block-end: 2px solid var(--accent-gold);
  }

  :global([data-theme="dark"]) .word-unit.highlighted {
    background-color: rgba(242, 217, 140, 0.15);
  }

  .word-ar {
    font-family: var(--font-arabic);
    font-size: 1.5rem;
    line-height: 1.7;
    color: var(--color-text-primary);
    text-align: center;
  }

  @media (min-width: 640px) {
    .word-ar {
      font-size: 1.65rem;
    }
  }

  .word-en {
    font-family: var(--font-sans);
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--color-text-tertiary);
    text-align: center;
    max-inline-size: 8rem;
    overflow-wrap: break-word;
  }

  .translation {
    font-family: var(--font-display);
    font-size: 1.0625rem;
    font-weight: 500;
    line-height: 1.5;
    color: var(--color-text-primary);
    margin: 0;
    text-align: start;
  }

  .reference {
    font-family: var(--font-display);
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--color-text-tertiary);
    margin: 0;
    text-align: start;
    padding-top: var(--spacing-xs);
    border-top: 2px solid var(--accent-gold);
  }

  :global([data-theme="dark"]) .reference {
    border-top-color: var(--accent-gold);
  }

  /* Mobile: tighter padding */
  @media (max-width: 640px) {
    .arabic-example {
      padding: var(--spacing-sm) var(--spacing-md);
      margin-block: var(--spacing-md);
      gap: var(--spacing-xs);
      border-radius: var(--radius-lg);
    }

    .interlinear {
      gap: var(--spacing-xs);
    }

    .word-unit {
      padding: 2px var(--spacing-xs);
    }

    .word-ar {
      font-size: 1.3rem;
    }

    .word-en {
      font-size: 0.6875rem;
      max-inline-size: 6rem;
    }
  }
</style>
