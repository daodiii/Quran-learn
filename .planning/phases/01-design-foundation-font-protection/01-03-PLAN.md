---
phase: 01-design-foundation-font-protection
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - tests/font-verification.spec.ts
  - playwright.config.ts
  - package.json
autonomous: false

must_haves:
  truths:
    - "Font checksum test verifies all 9 font files match baseline"
    - "Visual regression captures Arabic text rendering in light and dark modes"
    - "Dark mode contrast ratios meet WCAG 7:1 for Arabic text"
  artifacts:
    - path: "tests/font-verification.spec.ts"
      provides: "Playwright tests for font checksum and visual verification"
      contains: "test.describe"
      exports: []
    - path: "playwright.config.ts"
      provides: "Playwright configuration for visual regression"
      contains: "defineConfig"
  key_links:
    - from: "tests/font-verification.spec.ts"
      to: "tests/font-checksums.json"
      via: "import/require"
      pattern: "font-checksums"
    - from: "tests/font-verification.spec.ts"
      to: "localhost:4321"
      via: "page.goto"
      pattern: "localhost:4321"
---

<objective>
Create automated font verification tests and capture visual regression baselines for Arabic typography.

Purpose: Research identified that font rendering changes are subtle and easy to miss during refactoring. Automated checksum verification catches file modifications, visual regression tests catch rendering differences, and contrast validation ensures WCAG compliance.

Output: Playwright test suite for fonts, visual regression baseline screenshots, passing verification tests.
</objective>

<execution_context>
@/Users/daodilyas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daodilyas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/daodilyas/quran-learn/.planning/PROJECT.md
@/Users/daodilyas/quran-learn/.planning/phases/01-design-foundation-font-protection/01-RESEARCH.md
@/Users/daodilyas/quran-learn/.planning/phases/01-design-foundation-font-protection/01-01-SUMMARY.md
@/Users/daodilyas/quran-learn/.planning/phases/01-design-foundation-font-protection/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Playwright configuration and font verification tests</name>
  <files>playwright.config.ts, tests/font-verification.spec.ts, package.json</files>
  <action>
**1. Create playwright.config.ts in project root:**
```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:4321',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
  webServer: {
    command: 'npm run preview',
    url: 'http://localhost:4321',
    reuseExistingServer: !process.env.CI,
  },
});
```

**2. Create tests/font-verification.spec.ts:**
```typescript
import { test, expect } from '@playwright/test';
import { createHash } from 'crypto';
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

// Load baseline checksums
const checksums = JSON.parse(
  readFileSync(join(__dirname, 'font-checksums.json'), 'utf-8')
);

test.describe('Font File Protection', () => {
  test('all Arabic font files match baseline checksums', () => {
    const fontFiles = Object.keys(checksums.files);

    for (const fontPath of fontFiles) {
      const fullPath = join(process.cwd(), fontPath);
      expect(existsSync(fullPath), `Font file missing: ${fontPath}`).toBe(true);

      const content = readFileSync(fullPath);
      const hash = createHash('sha256').update(content).digest('hex');

      expect(hash, `Font ${fontPath} has been modified`).toBe(checksums.files[fontPath]);
    }
  });
});

test.describe('Arabic Font Rendering', () => {
  test.beforeEach(async ({ page }) => {
    // Wait for fonts to load before each test
    await page.goto('/');
    await page.waitForLoadState('networkidle');
  });

  test('UthmanicHafs font loads for Quranic text', async ({ page }) => {
    // Navigate to a surah page that has Arabic content
    await page.goto('/surahs/');
    await page.waitForLoadState('networkidle');

    // Check if Arabic text elements exist and use correct font
    const arabicElement = page.locator('.arabic').first();

    if (await arabicElement.count() > 0) {
      const fontFamily = await arabicElement.evaluate(
        el => window.getComputedStyle(el).fontFamily
      );
      expect(fontFamily).toContain('KFGQPC Hafs Uthmani');
    }
  });

  test('Arabic text renders correctly in light mode', async ({ page }) => {
    await page.goto('/learn/');
    await page.waitForLoadState('networkidle');

    // Ensure light mode
    await page.evaluate(() => {
      document.documentElement.removeAttribute('data-theme');
    });

    // Visual regression snapshot
    const arabicContent = page.locator('.arabic, .arabic-lg, .arabic-xl').first();
    if (await arabicContent.count() > 0) {
      await expect(arabicContent).toHaveScreenshot('arabic-light-mode.png', {
        maxDiffPixelRatio: 0.01, // 1% tolerance for anti-aliasing
      });
    }
  });

  test('Arabic text renders correctly in dark mode', async ({ page }) => {
    await page.goto('/learn/');
    await page.waitForLoadState('networkidle');

    // Switch to dark mode
    await page.evaluate(() => {
      document.documentElement.setAttribute('data-theme', 'dark');
    });

    // Wait for transition
    await page.waitForTimeout(500);

    // Visual regression snapshot
    const arabicContent = page.locator('.arabic, .arabic-lg, .arabic-xl').first();
    if (await arabicContent.count() > 0) {
      await expect(arabicContent).toHaveScreenshot('arabic-dark-mode.png', {
        maxDiffPixelRatio: 0.01,
      });
    }
  });
});

test.describe('Dark Mode Contrast', () => {
  test('text has sufficient contrast in dark mode', async ({ page }) => {
    await page.goto('/learn/');

    // Switch to dark mode
    await page.evaluate(() => {
      document.documentElement.setAttribute('data-theme', 'dark');
    });

    await page.waitForTimeout(300);

    // Get computed colors
    const colors = await page.evaluate(() => {
      const body = document.body;
      const style = window.getComputedStyle(body);
      return {
        textColor: style.color,
        bgColor: style.backgroundColor,
      };
    });

    // Log for manual verification (automated contrast calculation is complex)
    console.log('Dark mode colors:', colors);

    // Basic sanity check - text should be light, background dark
    expect(colors.textColor).toContain('255'); // White-ish
    expect(colors.bgColor).toContain('15'); // #0f0f0f dark
  });
});
```

**3. Add test scripts to package.json:**
```json
{
  "scripts": {
    "test:fonts": "npx playwright test tests/font-verification.spec.ts",
    "test:fonts:update": "npx playwright test tests/font-verification.spec.ts --update-snapshots"
  }
}
```
  </action>
  <verify>
1. playwright.config.ts exists in project root
2. tests/font-verification.spec.ts exists
3. `npm run test:fonts -- --list` shows test names
  </verify>
  <done>
Playwright config and font verification tests created
  </done>
</task>

<task type="auto">
  <name>Task 2: Build project and capture visual regression baselines</name>
  <files>tests/font-verification.spec.ts-snapshots/</files>
  <action>
1. Build the project for preview server:
   `npm run build`

2. Run tests with snapshot update to capture baselines:
   `npm run test:fonts:update`

   This will:
   - Start the preview server (localhost:4321)
   - Run font checksum verification
   - Capture baseline screenshots for visual regression
   - Store snapshots in tests/font-verification.spec.ts-snapshots/

3. Verify all tests pass after baseline capture:
   `npm run test:fonts`

If checksum test fails: The checksums in font-checksums.json need to match the actual font files. Re-run the checksum generation from Plan 01.

If visual tests fail on first run: This is expected - run with --update-snapshots to create baselines.
  </action>
  <verify>
1. `ls tests/font-verification.spec.ts-snapshots/` shows baseline images
2. `npm run test:fonts` passes (all green)
3. tests/font-verification.spec.ts-snapshots/ contains arabic-light-mode.png and arabic-dark-mode.png
  </verify>
  <done>
Visual regression baselines captured, all font verification tests pass
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 1 complete: Design token system with font protection infrastructure

1. Font declarations isolated in src/styles/fonts.css (9 @font-face rules)
2. Semantic design tokens in src/styles/tokens/ (colors, spacing, typography, shadows)
3. Font verification tests with checksum and visual regression
4. Light/dark mode preserved via CSS variable scoping
  </what-built>
  <how-to-verify>
1. **Font rendering check:**
   - Open http://localhost:4321/learn/ in browser
   - Verify Arabic text renders with correct font (not system fallback)
   - Text should appear elegant, not blocky

2. **Dark mode check:**
   - Click theme toggle (if exists) or run in console:
     `document.documentElement.setAttribute('data-theme', 'dark')`
   - Verify colors change smoothly
   - Verify Arabic text is clearly readable (high contrast)
   - Toggle back: `document.documentElement.removeAttribute('data-theme')`

3. **Design consistency check:**
   - Navigate between pages (Home, Learn, Surahs)
   - Verify consistent styling (colors, spacing, shadows)
   - No visual regressions from before Phase 1

4. **Run verification tests:**
   - `npm run test:fonts` - all tests should pass
  </how-to-verify>
  <resume-signal>Type "approved" if fonts render correctly and dark mode works, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. Test infrastructure:
   - playwright.config.ts exists
   - tests/font-verification.spec.ts has 5+ test cases
   - tests/font-verification.spec.ts-snapshots/ has baseline images

2. All tests pass:
   - `npm run test:fonts` returns 0 exit code
   - No failing assertions

3. Visual verification:
   - Human confirmed Arabic fonts render correctly
   - Human confirmed dark mode works with good contrast
</verification>

<success_criteria>
1. Playwright configured with test suite for fonts
2. Font checksum test verifies all 9 files unchanged
3. Visual regression baselines captured for light and dark modes
4. `npm run test:fonts` passes all tests
5. Human verified Arabic font rendering and dark mode contrast
</success_criteria>

<output>
After completion, create `.planning/phases/01-design-foundation-font-protection/01-03-SUMMARY.md`
</output>
