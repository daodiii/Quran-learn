---
phase: 05-navigation-system
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - src/layouts/LessonLayout.astro
  - src/layouts/BaseLayout.astro
  - src/scripts/navigation.ts
autonomous: true

must_haves:
  truths:
    - "Sidebar opens and closes on mobile with toggle button"
    - "Escape key closes the sidebar on mobile"
    - "Focus is trapped within sidebar when open on mobile"
    - "Active lesson scrolls into view when sidebar opens"
    - "Level expand/collapse state persists via localStorage"
    - "Breadcrumbs display on lesson pages showing Home > Learn > Level > Lesson"
  artifacts:
    - path: "src/scripts/navigation.ts"
      provides: "Sidebar toggle, focus trap, keyboard navigation, localStorage persistence"
      min_lines: 100
      contains: "trapFocus"
    - path: "src/layouts/LessonLayout.astro"
      provides: "Lesson page layout with CourseNavigator and Breadcrumbs"
      contains: "CourseNavigator"
    - path: "src/layouts/BaseLayout.astro"
      provides: "Global layout with navigation script"
      contains: "navigation.ts"
  key_links:
    - from: "src/scripts/navigation.ts"
      to: "#course-navigator"
      via: "DOM query for sidebar element"
      pattern: "getElementById\\(['\"]course-navigator['\"]\\)"
    - from: "src/scripts/navigation.ts"
      to: "localStorage"
      via: "State persistence for level sections"
      pattern: "localStorage\\.(get|set)Item"
    - from: "src/layouts/LessonLayout.astro"
      to: "src/components/navigation/Breadcrumbs.astro"
      via: "Component import"
      pattern: "import.*Breadcrumbs"
---

<objective>
Integrate navigation components into layouts and add JavaScript behaviors

Purpose: Wire up the navigation system with toggle behavior, keyboard navigation, focus trapping, and state persistence
Output: Functional sidebar with full keyboard support and breadcrumb integration in layouts
</objective>

<execution_context>
@/Users/daodilyas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daodilyas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-navigation-system/05-RESEARCH.md

@src/layouts/LessonLayout.astro
@src/layouts/BaseLayout.astro
@.planning/phases/05-navigation-system/05-01-SUMMARY.md
@.planning/phases/05-navigation-system/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create navigation JavaScript module</name>
  <files>src/scripts/navigation.ts</files>
  <action>
Create navigation.ts with all sidebar interaction logic following patterns from RESEARCH.md.

Module structure:
```typescript
// src/scripts/navigation.ts

// Constants
const SIDEBAR_ID = 'course-navigator';
const BACKDROP_ID = 'navigator-backdrop';
const TOGGLE_ID = 'navigator-toggle';
const CLOSE_ID = 'close-navigator';
const MOBILE_BREAKPOINT = 1024;

// State
let focusTrapCleanup: (() => void) | null = null;

// Initialize on DOM ready
export function initNavigation(): void {
  initSidebarToggle();
  initLevelSections();
  restoreLevelStates();
  scrollActiveLessonIntoView();
}

// Sidebar toggle functionality
function initSidebarToggle(): void {
  const toggle = document.getElementById(TOGGLE_ID);
  const closeBtn = document.getElementById(CLOSE_ID);
  const backdrop = document.getElementById(BACKDROP_ID);

  toggle?.addEventListener('click', toggleSidebar);
  closeBtn?.addEventListener('click', closeSidebar);
  backdrop?.addEventListener('click', closeSidebar);

  // Handle Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isSidebarOpen()) {
      closeSidebar();
    }
  });

  // Handle resize - close sidebar if going to desktop
  window.addEventListener('resize', () => {
    if (window.innerWidth >= MOBILE_BREAKPOINT && isSidebarOpen()) {
      closeSidebar();
    }
  });
}

function isSidebarOpen(): boolean {
  return document.getElementById(SIDEBAR_ID)?.classList.contains('open') ?? false;
}

function toggleSidebar(): void {
  if (isSidebarOpen()) {
    closeSidebar();
  } else {
    openSidebar();
  }
}

function openSidebar(): void {
  const sidebar = document.getElementById(SIDEBAR_ID);
  const backdrop = document.getElementById(BACKDROP_ID);
  const toggle = document.getElementById(TOGGLE_ID);

  if (!sidebar) return;

  sidebar.classList.add('open');
  backdrop?.classList.add('visible');
  toggle?.setAttribute('aria-expanded', 'true');

  // Prevent body scroll on mobile
  document.body.style.overflow = 'hidden';

  // Enable focus trap
  focusTrapCleanup = trapFocus(sidebar);

  // Scroll active lesson into view after a brief delay for animation
  setTimeout(() => scrollActiveLessonIntoView(), 300);
}

function closeSidebar(): void {
  const sidebar = document.getElementById(SIDEBAR_ID);
  const backdrop = document.getElementById(BACKDROP_ID);
  const toggle = document.getElementById(TOGGLE_ID);

  if (!sidebar) return;

  sidebar.classList.remove('open');
  backdrop?.classList.remove('visible');
  toggle?.setAttribute('aria-expanded', 'false');

  // Restore body scroll
  document.body.style.overflow = '';

  // Disable focus trap
  focusTrapCleanup?.();
  focusTrapCleanup = null;

  // Return focus to toggle button
  toggle?.focus();
}

// Focus trap for mobile overlay
function trapFocus(container: HTMLElement): () => void {
  const focusableSelectors = [
    'a[href]',
    'button:not([disabled])',
    'input:not([disabled])',
    'select:not([disabled])',
    'textarea:not([disabled])',
    '[tabindex]:not([tabindex="-1"])',
  ].join(',');

  const focusableElements = Array.from(
    container.querySelectorAll(focusableSelectors)
  ) as HTMLElement[];

  if (focusableElements.length === 0) return () => {};

  const firstFocusable = focusableElements[0];
  const lastFocusable = focusableElements[focusableElements.length - 1];

  function handleTabKey(e: KeyboardEvent): void {
    if (e.key !== 'Tab') return;

    if (e.shiftKey) {
      if (document.activeElement === firstFocusable) {
        e.preventDefault();
        lastFocusable.focus();
      }
    } else {
      if (document.activeElement === lastFocusable) {
        e.preventDefault();
        firstFocusable.focus();
      }
    }
  }

  container.addEventListener('keydown', handleTabKey);
  firstFocusable?.focus();

  return () => {
    container.removeEventListener('keydown', handleTabKey);
  };
}

// Level section expand/collapse
function initLevelSections(): void {
  const headers = document.querySelectorAll('.level-header');

  headers.forEach((header) => {
    header.addEventListener('click', () => {
      const isExpanded = header.getAttribute('aria-expanded') === 'true';
      const targetId = header.getAttribute('aria-controls');
      const target = targetId ? document.getElementById(targetId) : null;
      const level = header.closest('.level-section')?.getAttribute('data-level');

      if (!target || !level) return;

      const newState = !isExpanded;
      header.setAttribute('aria-expanded', String(newState));

      if (newState) {
        target.removeAttribute('hidden');
      } else {
        target.setAttribute('hidden', '');
      }

      // Persist state
      saveLevelState(Number(level), newState);
    });

    // Arrow key navigation within level
    header.addEventListener('keydown', (e: Event) => {
      const keyEvent = e as KeyboardEvent;
      if (keyEvent.key === 'ArrowLeft' || keyEvent.key === 'ArrowRight') {
        const isExpanded = header.getAttribute('aria-expanded') === 'true';
        const isRtl = document.dir === 'rtl';

        // ArrowRight expands (LTR), ArrowLeft expands (RTL)
        const shouldExpand = isRtl
          ? keyEvent.key === 'ArrowLeft'
          : keyEvent.key === 'ArrowRight';

        if (shouldExpand && !isExpanded) {
          (header as HTMLButtonElement).click();
        } else if (!shouldExpand && isExpanded) {
          (header as HTMLButtonElement).click();
        }
      }
    });
  });
}

// localStorage persistence
function saveLevelState(level: number, isExpanded: boolean): void {
  try {
    localStorage.setItem(`nav-level-${level}-expanded`, String(isExpanded));
  } catch {
    // localStorage not available, ignore
  }
}

function restoreLevelStates(): void {
  for (let level = 1; level <= 5; level++) {
    try {
      const saved = localStorage.getItem(`nav-level-${level}-expanded`);
      if (saved === 'true') {
        const section = document.querySelector(`[data-level="${level}"]`);
        const header = section?.querySelector('.level-header') as HTMLButtonElement;
        const list = section?.querySelector('.lesson-list');

        if (header && list) {
          header.setAttribute('aria-expanded', 'true');
          list.removeAttribute('hidden');
        }
      }
    } catch {
      // localStorage not available, ignore
    }
  }
}

// Scroll active lesson into view
function scrollActiveLessonIntoView(): void {
  const activeLesson = document.querySelector('.lesson-item[aria-current="page"]') as HTMLElement;
  if (!activeLesson) return;

  // Expand parent level if collapsed
  const levelSection = activeLesson.closest('.level-section');
  const levelHeader = levelSection?.querySelector('.level-header') as HTMLButtonElement;

  if (levelHeader && levelHeader.getAttribute('aria-expanded') === 'false') {
    levelHeader.click();
    // Wait for expansion animation
    setTimeout(() => {
      activeLesson.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 300);
  } else {
    activeLesson.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

// Auto-initialize when script loads
if (typeof document !== 'undefined') {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNavigation);
  } else {
    initNavigation();
  }
}
```
  </action>
  <verify>
- File exists at src/scripts/navigation.ts
- Contains trapFocus function
- Contains localStorage.getItem and localStorage.setItem
- Contains getElementById('course-navigator')
- Contains Escape key handler
- Contains ArrowLeft/ArrowRight key handlers
  </verify>
  <done>Navigation script handles toggle, focus trap, keyboard nav, and state persistence</done>
</task>

<task type="auto">
  <name>Task 2: Update LessonLayout with navigation components</name>
  <files>src/layouts/LessonLayout.astro</files>
  <action>
Update LessonLayout.astro to include CourseNavigator, NavigatorToggle, Breadcrumbs, and backdrop.

Add these imports at the top:
```astro
import CourseNavigator from '../components/navigation/CourseNavigator.astro';
import NavigatorToggle from '../components/navigation/NavigatorToggle.astro';
import Breadcrumbs from '../components/navigation/Breadcrumbs.astro';
```

Build breadcrumb items from lesson data:
```astro
const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: 'Learn', href: '/learn/' },
  { label: `Level ${entry.data.level}`, href: `/learn/#level-${entry.data.level}` },
  { label: entry.data.title }
];
```

Update the layout structure to include:
1. Backdrop div for mobile overlay: `<div id="navigator-backdrop" class="navigator-backdrop"></div>`
2. CourseNavigator component in sidebar position
3. Breadcrumbs at top of content area
4. NavigatorToggle (floating variant) for quick access on mobile

Updated structure (conceptual):
```astro
<BaseLayout title={title}>
  <!-- Backdrop for mobile sidebar -->
  <div id="navigator-backdrop" class="navigator-backdrop"></div>

  <div class="lesson-layout">
    <!-- Sidebar -->
    <aside class="lesson-sidebar">
      <CourseNavigator currentLessonSlug={entry.id} />
    </aside>

    <!-- Main content -->
    <main class="lesson-main">
      <Breadcrumbs items={breadcrumbItems} />
      <article class="lesson-content">
        <slot />
      </article>
    </main>
  </div>

  <!-- Floating toggle for mobile -->
  <NavigatorToggle variant="floating" />
</BaseLayout>
```

Add CSS for backdrop:
```css
.navigator-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 39;
  opacity: 0;
  pointer-events: none;
  transition: opacity 300ms ease;
}

.navigator-backdrop.visible {
  opacity: 1;
  pointer-events: auto;
}
```

Update lesson-layout grid:
- Desktop: sidebar 280px fixed, main flexible
- Mobile: full width, sidebar becomes overlay
  </action>
  <verify>
- LessonLayout.astro imports CourseNavigator, NavigatorToggle, Breadcrumbs
- Contains navigator-backdrop div with id
- Contains Breadcrumbs with items prop
- CourseNavigator is rendered in sidebar position
- CSS includes backdrop styles
  </verify>
  <done>LessonLayout includes full navigation system with sidebar, breadcrumbs, and floating toggle</done>
</task>

<task type="auto">
  <name>Task 3: Update BaseLayout to include navigation script</name>
  <files>src/layouts/BaseLayout.astro</files>
  <action>
Update BaseLayout.astro to include the navigation script and NavigatorToggle in header.

Add script import in the head or body:
```astro
<script src="../scripts/navigation.ts"></script>
```

Or inline with type="module":
```html
<script>
  import { initNavigation } from '../scripts/navigation.ts';
  // Navigation initializes itself, but we can also call for Astro view transitions
  document.addEventListener('astro:page-load', () => {
    // Re-initialize after page transitions if using View Transitions
    if (typeof initNavigation === 'function') {
      initNavigation();
    }
  });
</script>
```

Add NavigatorToggle to Header component (this requires updating the Header to accept it as a slot or modifying directly):

Option A: Pass NavigatorToggle as slot to Header
Option B: Modify Header.astro to include NavigatorToggle by default

Since we already added the navigator-toggle button placeholder in 05-01 Header simplification, we just need to ensure the navigation.ts script is loaded.

If Astro view transitions are used, add re-initialization hook:
```astro
<script>
  document.addEventListener('astro:page-load', () => {
    // Re-initialize navigation on page transitions
    const initNav = () => {
      const event = new Event('navigation:init');
      document.dispatchEvent(event);
    };
    initNav();
  });
</script>
```

Update the navigation.ts to listen for this event as alternative initialization.
  </action>
  <verify>
- BaseLayout.astro includes navigation.ts script
- Navigation initializes on page load
- Works with Astro view transitions if enabled
  </verify>
  <done>BaseLayout loads navigation script for global sidebar functionality</done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Dev server works: `npm run dev`
3. Navigate to a lesson page and verify:
   - Sidebar visible on desktop (>= 1024px)
   - Sidebar overlay on mobile (< 1024px)
   - Toggle button opens/closes sidebar
   - Escape key closes sidebar
   - Breadcrumbs display correctly
4. Expand/collapse level sections
5. Refresh page - level states persist via localStorage
</verification>

<success_criteria>
- Navigation script handles all sidebar interactions
- Focus is trapped in sidebar when open on mobile
- Escape and toggle button close sidebar
- Level expand/collapse states persist across page loads
- Breadcrumbs render on lesson pages with correct hierarchy
- Active lesson scrolls into view when sidebar opens
- Arrow keys expand/collapse level sections (RTL-aware)
</success_criteria>

<output>
After completion, create `.planning/phases/05-navigation-system/05-03-SUMMARY.md`
</output>
