---
phase: 05-navigation-system
plan: 04
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - tests/navigation.spec.ts
  - src/pages/test/navigation.astro
autonomous: true

must_haves:
  truths:
    - "Playwright tests verify sidebar toggle functionality"
    - "Keyboard navigation tests pass (Tab, Escape, Arrow keys)"
    - "RTL breadcrumb separator is tested"
    - "Mobile overlay behavior is tested"
    - "Level section expand/collapse is tested"
    - "Focus trap is tested on mobile"
  artifacts:
    - path: "tests/navigation.spec.ts"
      provides: "Comprehensive navigation test suite"
      min_lines: 150
      contains: "keyboard"
    - path: "src/pages/test/navigation.astro"
      provides: "Test page with navigation components"
      min_lines: 50
      contains: "CourseNavigator"
  key_links:
    - from: "tests/navigation.spec.ts"
      to: "/test/navigation"
      via: "Test page URL"
      pattern: "goto.*test/navigation"
    - from: "tests/navigation.spec.ts"
      to: "aria-expanded"
      via: "ARIA attribute assertions"
      pattern: "getAttribute.*aria-expanded"
---

<objective>
Create Playwright test suite for navigation system

Purpose: Ensure navigation components work correctly across viewports, with keyboard, and in RTL mode
Output: Comprehensive test suite covering sidebar, breadcrumbs, keyboard navigation, and accessibility
</objective>

<execution_context>
@/Users/daodilyas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daodilyas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@tests/components.spec.ts
@tests/cards.spec.ts
@.planning/phases/05-navigation-system/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create navigation test page</name>
  <files>src/pages/test/navigation.astro</files>
  <action>
Create a test page that renders all navigation components in both LTR and RTL modes.

```astro
---
import BaseLayout from '../../layouts/BaseLayout.astro';
import CourseNavigator from '../../components/navigation/CourseNavigator.astro';
import NavigatorToggle from '../../components/navigation/NavigatorToggle.astro';
import Breadcrumbs from '../../components/navigation/Breadcrumbs.astro';

const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: 'Learn', href: '/learn/' },
  { label: 'Level 1', href: '/learn/#level-1' },
  { label: 'Arabic Alphabet' }
];
---

<BaseLayout title="Navigation Test">
  <!-- Backdrop for mobile -->
  <div id="navigator-backdrop" class="navigator-backdrop" data-testid="navigator-backdrop"></div>

  <div class="test-layout">
    <!-- Sidebar section -->
    <section class="test-section" data-testid="sidebar-section">
      <h2>Course Navigator</h2>
      <aside class="test-sidebar">
        <CourseNavigator currentLessonSlug="level-1/01-arabic-alphabet" />
      </aside>
    </section>

    <!-- Main content section -->
    <main class="test-main">
      <!-- Breadcrumbs section -->
      <section class="test-section" data-testid="breadcrumbs-section">
        <h2>Breadcrumbs (LTR)</h2>
        <Breadcrumbs items={breadcrumbItems} />
      </section>

      <!-- RTL Breadcrumbs section -->
      <section class="test-section" dir="rtl" data-testid="breadcrumbs-rtl-section">
        <h2>Breadcrumbs (RTL)</h2>
        <Breadcrumbs items={breadcrumbItems} />
      </section>

      <!-- Navigator Toggle section -->
      <section class="test-section" data-testid="toggle-section">
        <h2>Navigator Toggle</h2>
        <div class="toggle-variants">
          <div>
            <h3>Header Variant</h3>
            <NavigatorToggle variant="header" />
          </div>
          <div>
            <h3>Floating Variant</h3>
            <NavigatorToggle variant="floating" class="relative-position" />
          </div>
        </div>
      </section>

      <!-- Keyboard Navigation Instructions -->
      <section class="test-section" data-testid="keyboard-section">
        <h2>Keyboard Navigation Test</h2>
        <p>Test these keyboard interactions:</p>
        <ul>
          <li>Tab through sidebar links</li>
          <li>Enter to activate links</li>
          <li>Escape to close mobile overlay</li>
          <li>Arrow Left/Right to collapse/expand level sections</li>
        </ul>
      </section>
    </main>
  </div>

  <!-- Floating toggle for mobile testing -->
  <NavigatorToggle variant="floating" />
</BaseLayout>

<style>
  .test-layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 2rem;
    padding: 2rem;
    max-inline-size: 80rem;
    margin-inline: auto;
  }

  @media (max-width: 1023px) {
    .test-layout {
      grid-template-columns: 1fr;
    }

    .test-sidebar {
      display: none;
    }
  }

  .test-section {
    background: var(--bg-elevated);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-xl);
    padding: 1.5rem;
    margin-block-end: 1.5rem;
  }

  .test-section h2 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-block-end: 1rem;
    color: var(--text-primary);
  }

  .test-section h3 {
    font-size: 0.875rem;
    font-weight: 500;
    margin-block-end: 0.5rem;
    color: var(--text-secondary);
  }

  .toggle-variants {
    display: flex;
    gap: 2rem;
  }

  .relative-position {
    position: relative;
    inset: 0;
  }

  .navigator-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 39;
    opacity: 0;
    pointer-events: none;
    transition: opacity 300ms ease;
  }

  .navigator-backdrop.visible {
    opacity: 1;
    pointer-events: auto;
  }

  /* Force floating toggle visible for testing */
  :global(.navigator-toggle--floating) {
    display: flex !important;
  }
</style>
```
  </action>
  <verify>
- File exists at src/pages/test/navigation.astro
- Contains CourseNavigator component
- Contains Breadcrumbs in both LTR and RTL sections
- Contains NavigatorToggle variants
- Has data-testid attributes
  </verify>
  <done>Navigation test page renders all components for Playwright testing</done>
</task>

<task type="auto">
  <name>Task 2: Create navigation Playwright tests</name>
  <files>tests/navigation.spec.ts</files>
  <action>
Create comprehensive Playwright tests for navigation system.

```typescript
import { test, expect } from '@playwright/test';

test.describe('Navigation System', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/test/navigation');
  });

  test.describe('CourseNavigator', () => {
    test('displays all 5 level sections', async ({ page }) => {
      const levelSections = page.locator('.level-section');
      await expect(levelSections).toHaveCount(5);
    });

    test('level headers have correct ARIA attributes', async ({ page }) => {
      const levelHeaders = page.locator('.level-header');
      const firstHeader = levelHeaders.first();

      await expect(firstHeader).toHaveAttribute('aria-expanded');
      await expect(firstHeader).toHaveAttribute('aria-controls');
    });

    test('clicking level header toggles aria-expanded', async ({ page }) => {
      const firstHeader = page.locator('.level-header').first();
      const initialState = await firstHeader.getAttribute('aria-expanded');

      await firstHeader.click();
      const newState = await firstHeader.getAttribute('aria-expanded');

      expect(newState).not.toBe(initialState);
    });

    test('expanded level shows lesson list', async ({ page }) => {
      const firstHeader = page.locator('.level-header').first();
      const controlsId = await firstHeader.getAttribute('aria-controls');
      const lessonList = page.locator(`#${controlsId}`);

      // Expand if collapsed
      if (await firstHeader.getAttribute('aria-expanded') === 'false') {
        await firstHeader.click();
      }

      await expect(lessonList).not.toHaveAttribute('hidden');
    });

    test('lessons have proper link structure', async ({ page }) => {
      // Expand first level
      const firstHeader = page.locator('.level-header').first();
      await firstHeader.click();

      const lessonLinks = page.locator('.lesson-item');
      const firstLesson = lessonLinks.first();

      await expect(firstLesson).toHaveAttribute('href');
      await expect(firstLesson.locator('.lesson-number')).toBeVisible();
      await expect(firstLesson.locator('.lesson-title')).toBeVisible();
    });
  });

  test.describe('Breadcrumbs', () => {
    test('renders with correct ARIA label', async ({ page }) => {
      const breadcrumbs = page.locator('[data-testid="breadcrumbs-section"] nav');
      await expect(breadcrumbs).toHaveAttribute('aria-label', 'Breadcrumbs');
    });

    test('last item has aria-current="page"', async ({ page }) => {
      const breadcrumbs = page.locator('[data-testid="breadcrumbs-section"] nav');
      const lastItem = breadcrumbs.locator('li').last();
      const current = lastItem.locator('[aria-current="page"]');

      await expect(current).toBeVisible();
    });

    test('separator is hidden from screen readers', async ({ page }) => {
      const separators = page.locator('[data-testid="breadcrumbs-section"] .separator');
      const firstSeparator = separators.first();

      await expect(firstSeparator).toHaveAttribute('aria-hidden', 'true');
    });

    test('RTL mode uses correct separator', async ({ page }) => {
      const rtlSection = page.locator('[data-testid="breadcrumbs-rtl-section"]');
      const separator = rtlSection.locator('.separator').first();

      // Get computed content of ::before pseudo-element
      const content = await page.evaluate(() => {
        const el = document.querySelector('[data-testid="breadcrumbs-rtl-section"] .separator');
        if (!el) return '';
        return window.getComputedStyle(el, '::before').content;
      });

      // Should be "<" or contain "<" for RTL
      expect(content).toContain('<');
    });
  });

  test.describe('NavigatorToggle', () => {
    test('toggle button has correct ARIA attributes', async ({ page }) => {
      const toggle = page.locator('#navigator-toggle').first();

      await expect(toggle).toHaveAttribute('aria-expanded');
      await expect(toggle).toHaveAttribute('aria-label');
      await expect(toggle).toHaveAttribute('aria-controls', 'course-navigator');
    });

    test('toggle shows menu icon initially', async ({ page }) => {
      const toggle = page.locator('#navigator-toggle').first();
      const menuIcon = toggle.locator('.menu-icon');
      const closeIcon = toggle.locator('.close-icon');

      await expect(menuIcon).toBeVisible();
      await expect(closeIcon).not.toBeVisible();
    });
  });

  test.describe('Keyboard Navigation', () => {
    test('Tab navigates through sidebar links', async ({ page }) => {
      // Expand first level
      const firstHeader = page.locator('.level-header').first();
      await firstHeader.click();

      // Focus first level header
      await firstHeader.focus();

      // Tab to first lesson
      await page.keyboard.press('Tab');

      const focusedElement = page.locator(':focus');
      await expect(focusedElement).toHaveClass(/lesson-item/);
    });

    test('ArrowRight expands collapsed section (LTR)', async ({ page }) => {
      const firstHeader = page.locator('.level-header').first();

      // Ensure collapsed
      if (await firstHeader.getAttribute('aria-expanded') === 'true') {
        await firstHeader.click();
      }

      await firstHeader.focus();
      await page.keyboard.press('ArrowRight');

      await expect(firstHeader).toHaveAttribute('aria-expanded', 'true');
    });

    test('ArrowLeft collapses expanded section (LTR)', async ({ page }) => {
      const firstHeader = page.locator('.level-header').first();

      // Ensure expanded
      if (await firstHeader.getAttribute('aria-expanded') === 'false') {
        await firstHeader.click();
      }

      await firstHeader.focus();
      await page.keyboard.press('ArrowLeft');

      await expect(firstHeader).toHaveAttribute('aria-expanded', 'false');
    });

    test('focus indicators are visible', async ({ page }) => {
      const firstHeader = page.locator('.level-header').first();
      await firstHeader.focus();

      // Check for visible focus outline
      const outline = await firstHeader.evaluate((el) => {
        const style = window.getComputedStyle(el);
        return style.outline || style.outlineStyle;
      });

      expect(outline).not.toBe('none');
    });
  });

  test.describe('Mobile Overlay Behavior', () => {
    test.use({ viewport: { width: 375, height: 667 } });

    test('sidebar is hidden by default on mobile', async ({ page }) => {
      const sidebar = page.locator('#course-navigator');
      const transform = await sidebar.evaluate((el) => {
        return window.getComputedStyle(el).transform;
      });

      // Should be translated off-screen
      expect(transform).not.toBe('none');
    });

    test('toggle opens sidebar on mobile', async ({ page }) => {
      const toggle = page.locator('.navigator-toggle--floating');
      await toggle.click();

      const sidebar = page.locator('#course-navigator');
      await expect(sidebar).toHaveClass(/open/);
    });

    test('backdrop becomes visible when sidebar opens', async ({ page }) => {
      const toggle = page.locator('.navigator-toggle--floating');
      await toggle.click();

      const backdrop = page.locator('#navigator-backdrop');
      await expect(backdrop).toHaveClass(/visible/);
    });

    test('Escape key closes sidebar', async ({ page }) => {
      const toggle = page.locator('.navigator-toggle--floating');
      await toggle.click();

      await page.keyboard.press('Escape');

      const sidebar = page.locator('#course-navigator');
      await expect(sidebar).not.toHaveClass(/open/);
    });

    test('clicking backdrop closes sidebar', async ({ page }) => {
      const toggle = page.locator('.navigator-toggle--floating');
      await toggle.click();

      const backdrop = page.locator('#navigator-backdrop');
      await backdrop.click();

      const sidebar = page.locator('#course-navigator');
      await expect(sidebar).not.toHaveClass(/open/);
    });
  });

  test.describe('Dark Mode', () => {
    test('navigation components work in dark mode', async ({ page }) => {
      // Enable dark mode
      await page.evaluate(() => {
        document.documentElement.setAttribute('data-theme', 'dark');
      });

      // Verify components still render
      const breadcrumbs = page.locator('[data-testid="breadcrumbs-section"] nav');
      await expect(breadcrumbs).toBeVisible();

      const levelHeaders = page.locator('.level-header');
      await expect(levelHeaders.first()).toBeVisible();
    });
  });

  test.describe('Accessibility', () => {
    test('sidebar has navigation landmark', async ({ page }) => {
      const nav = page.locator('#course-navigator');
      await expect(nav).toHaveAttribute('aria-label', 'Course navigation');
    });

    test('level sections are properly structured', async ({ page }) => {
      const sections = page.locator('.level-section');
      const firstSection = sections.first();

      // Should have data-level attribute
      await expect(firstSection).toHaveAttribute('data-level');
    });
  });

  test.describe('Visual Regression', () => {
    test('navigation components match baseline (desktop)', async ({ page }) => {
      await expect(page).toHaveScreenshot('navigation-desktop.png', {
        fullPage: true,
        maxDiffPixels: 100
      });
    });

    test('navigation components match baseline (mobile)', async ({ page }) => {
      await page.setViewportSize({ width: 375, height: 667 });

      await expect(page).toHaveScreenshot('navigation-mobile.png', {
        fullPage: true,
        maxDiffPixels: 100
      });
    });

    test('mobile sidebar open state matches baseline', async ({ page }) => {
      await page.setViewportSize({ width: 375, height: 667 });

      const toggle = page.locator('.navigator-toggle--floating');
      await toggle.click();

      // Wait for animation
      await page.waitForTimeout(350);

      await expect(page).toHaveScreenshot('navigation-mobile-open.png', {
        fullPage: true,
        maxDiffPixels: 100
      });
    });
  });
});
```
  </action>
  <verify>
- File exists at tests/navigation.spec.ts
- Contains keyboard navigation tests
- Contains mobile overlay tests
- Contains RTL breadcrumb test
- Contains aria-expanded assertions
- Contains visual regression tests
  </verify>
  <done>Comprehensive navigation test suite covers sidebar, breadcrumbs, keyboard, mobile, and a11y</done>
</task>

<task type="auto">
  <name>Task 3: Run tests and capture baselines</name>
  <files></files>
  <action>
Run Playwright tests to verify functionality and capture visual regression baselines.

Commands:
```bash
# Start dev server in background
npm run dev &

# Wait for server to be ready
sleep 5

# Run navigation tests
npx playwright test tests/navigation.spec.ts --project=chromium

# If tests pass, update baselines if needed
npx playwright test tests/navigation.spec.ts --project=chromium --update-snapshots
```

Expected results:
- All navigation tests pass
- Visual regression baselines captured in tests/navigation.spec.ts-snapshots/

Fix any failing tests by updating components or test expectations.
  </action>
  <verify>
- All navigation tests pass: `npx playwright test tests/navigation.spec.ts --project=chromium`
- Visual regression baselines exist in tests/navigation.spec.ts-snapshots/
  </verify>
  <done>Navigation tests pass and visual baselines are captured</done>
</task>

</tasks>

<verification>
1. Test page accessible at /test/navigation
2. All Playwright tests pass: `npx playwright test tests/navigation.spec.ts --project=chromium`
3. Visual baselines captured for desktop, mobile, and mobile-open states
4. Keyboard navigation works as expected
5. RTL breadcrumb separator tested and passing
</verification>

<success_criteria>
- Navigation test page exists with all components
- 20+ Playwright tests covering:
  - Sidebar structure and ARIA
  - Breadcrumbs with RTL support
  - Toggle button states
  - Keyboard navigation (Tab, Arrow, Escape)
  - Mobile overlay behavior
  - Dark mode compatibility
  - Visual regression baselines
- All tests pass in CI (Chromium)
</success_criteria>

<output>
After completion, create `.planning/phases/05-navigation-system/05-04-SUMMARY.md`
</output>
