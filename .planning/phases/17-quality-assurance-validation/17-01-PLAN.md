---
phase: 17-quality-assurance-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/validate-diacritics.ts
  - scripts/validate-terminology.ts
  - scripts/validate-cross-lesson.ts
autonomous: true

must_haves:
  truths:
    - "Diacritics validator recognizes dagger alif (U+0670) and extended Arabic marks as valid diacritics"
    - "Terminology validator does not crash or false-positive on terms containing regex special characters"
    - "Terminology validator uses word boundary checks to prevent matching letter combinations inside unrelated words"
    - "Cross-lesson validator detects terminology inconsistencies across all 73 lessons"
    - "Cross-lesson validator detects prerequisite reference errors"
  artifacts:
    - path: "scripts/validate-diacritics.ts"
      provides: "Fixed diacritics Unicode range including U+0670 and extended marks"
      contains: "\\u0670"
    - path: "scripts/validate-terminology.ts"
      provides: "Regex-safe terminology matching with word boundaries"
      contains: "escapeRegex"
    - path: "scripts/validate-cross-lesson.ts"
      provides: "Cross-lesson terminology consistency and prerequisite validation"
      exports: ["validateCrossLesson"]
  key_links:
    - from: "scripts/validate-cross-lesson.ts"
      to: "scripts/validate-terminology.ts"
      via: "loadTerminology import"
      pattern: "import.*loadTerminology.*validate-terminology"
---

<objective>
Fix known validator bugs in diacritics and terminology validators, then create a new cross-lesson validator that detects terminology inconsistencies and broken prerequisite references across all 73 lessons.

Purpose: Existing validators have documented bugs (regex escaping, incomplete Unicode range, no word boundaries) that cause false positives/negatives. Cross-lesson consistency cannot be caught by single-file validators.
Output: Patched validate-diacritics.ts, patched validate-terminology.ts, new validate-cross-lesson.ts
</objective>

<execution_context>
@/Users/daodilyas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daodilyas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-quality-assurance-validation/17-RESEARCH.md

@scripts/validate-diacritics.ts
@scripts/validate-terminology.ts
@scripts/validate-content.ts
@docs/TERMINOLOGY.md
@docs/CURRICULUM_MAP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix known validator bugs in diacritics and terminology validators</name>
  <files>scripts/validate-diacritics.ts, scripts/validate-terminology.ts</files>
  <action>
Fix three documented bugs in existing validators:

**Bug 1: Diacritics validator Unicode range incomplete (validate-diacritics.ts line 12)**
- Current: `const ARABIC_DIACRITIC = /[\u064B-\u065F]/g;`
- Fix: `const ARABIC_DIACRITIC = /[\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E8\u06EA-\u06ED]/g;`
- This adds dagger alif (U+0670) and extended Quranic annotation marks
- The dagger alif fix resolves false positives on words like ٱلرَّحْمَٰنِ

**Bug 2: Terminology validator regex escaping (validate-terminology.ts lines 107-113)**
- Add an `escapeRegex` helper function before the `validateTerminology` export:
  ```typescript
  function escapeRegex(str: string): string {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }
  ```
- Update pattern1 (line 107-109): wrap `term.english` and `term.arabic` with `escapeRegex()`
  ```typescript
  const pattern1 = new RegExp(
    `${escapeRegex(term.english)}\\s*\\([^)]*${escapeRegex(term.arabic)}[^)]*\\)`
  );
  ```
- Update pattern2 (line 111-113): wrap `term.english` and `term.arabic` with `escapeRegex()`
  ```typescript
  const pattern2 = new RegExp(
    `\\[${escapeRegex(term.english)}\\]\\([^)]+\\)\\s*\\([^)]*${escapeRegex(term.arabic)}[^)]*\\)`
  );
  ```

**Bug 3: Terminology validator lacks word boundary checks (validate-terminology.ts line 98)**
- Current: `if (line.includes(term.arabic))` - matches Arabic letter combinations inside any word
- Fix: Use a regex with word-adjacent checks instead of simple includes:
  ```typescript
  // Use regex to check for Arabic term with surrounding non-Arabic context
  const arabicTermPattern = new RegExp(`(?:^|[^\\u0600-\\u06FF])${escapeRegex(term.arabic)}(?:$|[^\\u0600-\\u06FF\\u064B-\\u065F\\u0670])`);
  if (arabicTermPattern.test(line)) {
  ```
- This prevents matching Arabic substrings inside larger Arabic words while still matching the term when it appears as a standalone word or within parentheses

Do NOT change the overall structure or exports of either file. Preserve all existing functionality, CLI usage sections, and interfaces. Only patch the specific bugs.
  </action>
  <verify>
Run the existing validation suite to confirm no regressions:
```bash
npx tsx scripts/validate-content.ts 2>&1 | tail -5
```
The validator should still run without crashes. Error/warning counts may change (fewer false positives expected).
  </verify>
  <done>
- ARABIC_DIACRITIC regex includes \u0670 and extended ranges
- escapeRegex helper exists in validate-terminology.ts
- pattern1 and pattern2 use escapeRegex for both term.english and term.arabic
- Arabic term matching uses regex with non-Arabic boundary checks instead of simple includes()
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cross-lesson consistency validator</name>
  <files>scripts/validate-cross-lesson.ts</files>
  <action>
Create `scripts/validate-cross-lesson.ts` that analyzes all 73 lessons together for cross-file consistency issues. Use only Node.js built-ins (fs, path) consistent with the project's validation script conventions (no external dependencies).

**Structure:**
```typescript
import { readFileSync, readdirSync, statSync } from 'fs';
import { join, basename, dirname } from 'path';
import { fileURLToPath } from 'url';
import { loadTerminology } from './validate-terminology.js';
```

**Export interface:**
```typescript
export interface CrossLessonIssue {
  type: 'terminology_inconsistency' | 'missing_prerequisite' | 'duplicate_lesson_id';
  severity: 'error' | 'warning';
  message: string;
  files: string[];
  line?: number;
}

export function validateCrossLesson(): CrossLessonIssue[]
```

**Implementation requirements:**

1. **Find all lesson MDX files** recursively in `src/content/lessons/` (reuse the same pattern as validate-content.ts findMdxFiles, skip `_` prefixed files)

2. **Load each lesson** - read content, extract metadata from frontmatter (title, level, order, prerequisites if present)

3. **Check 1: Terminology consistency** - For each canonical term from TERMINOLOGY.md:
   - Track which English translation is used alongside each Arabic term across all lessons
   - If the same Arabic term is paired with different English translations in different lessons, flag as warning
   - Pattern to match: `SomeEnglish (something / arabicTerm)` or `SomeEnglish (arabicTerm)`
   - Report which files have the inconsistency

4. **Check 2: Prerequisite validation** - For each lesson frontmatter `prerequisites` array:
   - Verify each referenced lesson ID (e.g., "L1.01") corresponds to an actual lesson file
   - Map lesson IDs from frontmatter `level` and `order` fields (e.g., level 1, order 1 = L1.01)
   - Flag missing prerequisites as errors

5. **Check 3: Duplicate lesson ID detection** - Ensure no two lessons share the same level+order combination

**CLI section** at bottom (same pattern as other validators):
- `if (import.meta.url === ...)` guard
- Run validateCrossLesson(), print results, exit with code 1 if errors found

Keep the implementation simple and focused. Use Node.js built-ins only (no glob, no external packages). Target under 200 lines.
  </action>
  <verify>
Run the new validator directly:
```bash
npx tsx scripts/validate-cross-lesson.ts 2>&1 | tail -10
```
Should produce output listing any cross-lesson issues found, or confirm all checks passed.
  </verify>
  <done>
- scripts/validate-cross-lesson.ts exists with validateCrossLesson() export
- Checks terminology consistency across 73 lessons
- Checks prerequisite references exist
- Checks for duplicate lesson IDs
- Uses Node.js built-ins only (no external dependencies)
- CLI usage section present
  </done>
</task>

</tasks>

<verification>
1. `npx tsx scripts/validate-content.ts` runs without crashes (existing validators still work)
2. `npx tsx scripts/validate-cross-lesson.ts` runs and produces cross-lesson analysis output
3. In validate-diacritics.ts, ARABIC_DIACRITIC pattern includes `\u0670`
4. In validate-terminology.ts, `escapeRegex` function exists and is used in both pattern1 and pattern2
5. In validate-terminology.ts, Arabic term matching uses regex boundary checks not simple `includes()`
</verification>

<success_criteria>
- All three known validator bugs fixed (dagger alif, regex escaping, word boundaries)
- Cross-lesson validator detects terminology variations across the 73-lesson corpus
- No external dependencies added (Node.js built-ins only)
- Existing validate-content.ts orchestrator still works without modification
</success_criteria>

<output>
After completion, create `.planning/phases/17-quality-assurance-validation/17-01-SUMMARY.md`
</output>
