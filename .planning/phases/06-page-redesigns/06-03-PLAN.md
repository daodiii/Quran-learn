---
phase: 06-page-redesigns
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/layouts/LessonLayout.astro
  - src/pages/learn/[...slug].astro
autonomous: true

must_haves:
  truths:
    - "Lesson content constrained to 60-75ch (70ch) reading width"
    - "Floating navigator toggle visible on mobile"
    - "Previous/Next lesson navigation at bottom of lesson"
    - "Lesson article uses proper typography (17px, 1.75 line-height)"
    - "Arabic text blocks render correctly within content width"
  artifacts:
    - path: "src/layouts/LessonLayout.astro"
      provides: "Reading-width optimized lesson layout"
      contains: "max-inline-size: 70ch"
    - path: "src/pages/learn/[...slug].astro"
      provides: "Lesson page with prev/next navigation"
      contains: "prevLesson"
  key_links:
    - from: "src/layouts/LessonLayout.astro"
      to: "src/components/navigation/CourseNavigator.astro"
      via: "import"
      pattern: "import CourseNavigator"
    - from: "src/pages/learn/[...slug].astro"
      to: "src/layouts/LessonLayout.astro"
      via: "layout"
      pattern: "LessonLayout"
---

<objective>
Optimize lesson pages for reading with proper content width, typography, and prev/next navigation.

Purpose: Lesson pages are the core learning experience - optimal reading width (60-75ch) reduces eye strain and improves comprehension. Previous/Next navigation enables linear progression.
Output: Updated LessonLayout.astro with reading width constraints and [...slug].astro with prev/next links
</objective>

<execution_context>
@/Users/daodilyas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daodilyas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-page-redesigns/06-RESEARCH.md
@.planning/phases/05-navigation-system/05-03-SUMMARY.md
@src/layouts/LessonLayout.astro
@src/pages/learn/[...slug].astro
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Reading Width Constraints to LessonLayout</name>
  <files>src/layouts/LessonLayout.astro</files>
  <action>
Update LessonLayout.astro to constrain lesson content to optimal reading width:

1. Locate the article/content container (likely `.lesson-article` or similar from Phase 5 integration).

2. Add reading width CSS to the content area:
   ```css
   .lesson-content {
     /* Optimal reading width: 60-75 characters per line */
     max-inline-size: 70ch;
     margin-inline: auto;

     /* Typography for readability */
     font-size: 1.0625rem; /* 17px */
     line-height: 1.75;
     color: var(--text-secondary);
   }

   /* Heading styles within content */
   .lesson-content :global(h2) {
     font-size: 1.5rem;
     font-weight: 700;
     color: var(--text-primary);
     margin-block-start: var(--spacing-xl);
     margin-block-end: var(--spacing-md);
     padding-block-end: var(--spacing-sm);
     border-block-end: 1px solid var(--border-primary);
   }

   .lesson-content :global(h3) {
     font-size: 1.25rem;
     font-weight: 600;
     color: var(--text-primary);
     margin-block-start: var(--spacing-lg);
     margin-block-end: var(--spacing-sm);
   }

   .lesson-content :global(p) {
     margin-block-end: var(--spacing-md);
   }

   .lesson-content :global(ul),
   .lesson-content :global(ol) {
     margin-block-end: var(--spacing-md);
     padding-inline-start: var(--spacing-lg);
   }

   .lesson-content :global(li) {
     margin-block-end: var(--spacing-xs);
   }
   ```

3. Add Arabic text block styling:
   ```css
   /* Arabic text blocks within content */
   .lesson-content :global(.arabic-text),
   .lesson-content :global([lang="ar"]) {
     font-family: var(--font-arabic);
     font-size: 1.5rem;
     line-height: 2;
     direction: rtl;
     text-align: start;
     overflow-wrap: break-word;
   }

   /* Arabic inline examples */
   .lesson-content :global(.arabic-inline) {
     font-family: var(--font-arabic);
     font-size: 1.25em;
     direction: rtl;
     unicode-bidi: isolate;
   }
   ```

4. Ensure the content wrapper class is applied to the slot area where MDX content renders.

5. Update dark mode typography if needed:
   ```css
   [data-theme="dark"] .lesson-content {
     color: var(--text-secondary);
   }

   [data-theme="dark"] .lesson-content :global([lang="ar"]) {
     font-weight: 500; /* Optical compensation per Phase 4 */
   }
   ```
  </action>
  <verify>
Run `npm run dev` and navigate to any lesson page.
Content should be centered with readable line lengths (~70 characters).
Arabic text blocks should render correctly with proper font.
  </verify>
  <done>
Lesson content constrained to 70ch max width.
Typography uses 17px font size with 1.75 line-height.
Arabic text blocks use correct font family and direction.
Dark mode applies font-weight: 500 for Arabic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Previous/Next Lesson Navigation</name>
  <files>src/pages/learn/[...slug].astro</files>
  <action>
Update [...slug].astro to include previous/next lesson links:

1. In the frontmatter, calculate prev/next lessons:
   ```astro
   ---
   import { getCollection } from 'astro:content';
   import LessonLayout from '../../../layouts/LessonLayout.astro';

   export async function getStaticPaths() {
     const lessons = await getCollection('lessons');
     return lessons.map(lesson => ({
       params: { slug: lesson.id },
       props: { lesson },
     }));
   }

   const { lesson } = Astro.props;
   const { Content } = await lesson.render();

   // Get all lessons sorted for prev/next navigation
   const allLessons = await getCollection('lessons');
   const sortedLessons = allLessons.sort((a, b) => {
     if (a.data.level !== b.data.level) return a.data.level - b.data.level;
     return a.data.order - b.data.order;
   });

   const currentIndex = sortedLessons.findIndex(l => l.id === lesson.id);
   const prevLesson = currentIndex > 0 ? sortedLessons[currentIndex - 1] : null;
   const nextLesson = currentIndex < sortedLessons.length - 1 ? sortedLessons[currentIndex + 1] : null;
   ---
   ```

2. Pass prev/next to LessonLayout:
   ```astro
   <LessonLayout
     title={lesson.data.title}
     titleArabic={lesson.data.titleArabic}
     level={lesson.data.level}
     description={lesson.data.description}
     prevLesson={prevLesson ? { title: prevLesson.data.title, href: `/learn/${prevLesson.id}/` } : null}
     nextLesson={nextLesson ? { title: nextLesson.data.title, href: `/learn/${nextLesson.id}/` } : null}
   >
     <Content />
   </LessonLayout>
   ```

3. Update LessonLayout.astro Props interface to accept prevLesson/nextLesson:
   ```typescript
   interface Props {
     title: string;
     titleArabic?: string;
     level: number;
     description?: string;
     prevLesson?: { title: string; href: string } | null;
     nextLesson?: { title: string; href: string } | null;
   }
   ```

4. Add prev/next navigation component at bottom of LessonLayout:
   ```astro
   {(prevLesson || nextLesson) && (
     <nav class="lesson-nav" aria-label="Lesson navigation">
       {prevLesson ? (
         <a href={prevLesson.href} class="nav-link nav-prev">
           <svg class="nav-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
             <path fill="currentColor" d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
           </svg>
           <span class="nav-text">
             <span class="nav-label">Previous</span>
             <span class="nav-title">{prevLesson.title}</span>
           </span>
         </a>
       ) : <div />}

       {nextLesson ? (
         <a href={nextLesson.href} class="nav-link nav-next">
           <span class="nav-text">
             <span class="nav-label">Next</span>
             <span class="nav-title">{nextLesson.title}</span>
           </span>
           <svg class="nav-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
             <path fill="currentColor" d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/>
           </svg>
         </a>
       ) : <div />}
     </nav>
   )}
   ```

5. Style the navigation:
   ```css
   .lesson-nav {
     display: flex;
     justify-content: space-between;
     gap: var(--spacing-md);
     margin-block-start: var(--spacing-2xl);
     padding-block-start: var(--spacing-lg);
     border-block-start: 1px solid var(--border-primary);
   }

   .nav-link {
     display: flex;
     align-items: center;
     gap: var(--spacing-sm);
     padding: var(--spacing-md);
     background: var(--bg-elevated);
     border: 1px solid var(--border-primary);
     border-radius: var(--radius-lg);
     text-decoration: none;
     transition: all var(--transition-fast);
     max-inline-size: 45%;
   }

   .nav-link:hover {
     border-color: var(--accent-primary);
     background: var(--accent-primary-light);
   }

   .nav-prev {
     text-align: start;
   }

   .nav-next {
     text-align: end;
     margin-inline-start: auto;
   }

   .nav-text {
     display: flex;
     flex-direction: column;
   }

   .nav-label {
     font-size: 0.75rem;
     color: var(--text-tertiary);
     text-transform: uppercase;
     font-weight: 600;
   }

   .nav-title {
     font-size: 0.9375rem;
     color: var(--text-primary);
     font-weight: 500;
   }

   .nav-icon {
     flex-shrink: 0;
     color: var(--text-secondary);
   }

   /* RTL support */
   [dir="rtl"] .nav-prev .nav-icon {
     transform: scaleX(-1);
   }

   [dir="rtl"] .nav-next .nav-icon {
     transform: scaleX(-1);
   }
   ```
  </action>
  <verify>
Run `npm run build` - verify all 73 lesson pages generate correctly.
Navigate to a middle lesson - should have both prev and next links.
First lesson should only have next. Last lesson should only have prev.
  </verify>
  <done>
Prev/Next navigation appears at bottom of every lesson.
Links work correctly across level boundaries.
Navigation is keyboard accessible.
RTL icons flip correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Mark Complete Button and Floating Navigator</name>
  <files>src/layouts/LessonLayout.astro</files>
  <action>
Add lesson completion functionality and ensure floating navigator is visible:

1. Verify NavigatorToggle with floating variant is present (from Phase 5):
   ```astro
   import NavigatorToggle from '../components/navigation/NavigatorToggle.astro';

   <!-- At end of layout, before closing BaseLayout -->
   <NavigatorToggle variant="floating" />
   ```

2. Add "Mark as Complete" button after lesson content:
   ```astro
   <div class="lesson-actions">
     <button
       type="button"
       class="btn-complete"
       id="mark-complete-btn"
       data-lesson-slug={Astro.url.pathname}
     >
       <svg class="btn-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
         <path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
       </svg>
       <span class="btn-text">Mark as Complete</span>
     </button>
   </div>
   ```

3. Add completion button styles:
   ```css
   .lesson-actions {
     margin-block-start: var(--spacing-xl);
     padding-block-start: var(--spacing-lg);
     border-block-start: 1px solid var(--border-primary);
   }

   .btn-complete {
     display: inline-flex;
     align-items: center;
     gap: var(--spacing-sm);
     padding: var(--spacing-sm) var(--spacing-md);
     background: var(--accent-primary);
     color: white;
     border: none;
     border-radius: var(--radius-md);
     font-size: 0.9375rem;
     font-weight: 600;
     cursor: pointer;
     transition: all var(--transition-fast);
   }

   .btn-complete:hover {
     background: var(--accent-primary-hover);
   }

   .btn-complete[data-completed="true"] {
     background: var(--color-success);
     pointer-events: none;
   }

   .btn-complete[data-completed="true"] .btn-text::after {
     content: 'd';
   }
   ```

4. Add client-side script for completion:
   ```html
   <script>
     document.addEventListener('DOMContentLoaded', () => {
       const btn = document.getElementById('mark-complete-btn');
       if (!btn) return;

       const slug = btn.getAttribute('data-lesson-slug');
       const completedLessons = JSON.parse(localStorage.getItem('completedLessons') || '[]');

       // Check if already completed
       if (completedLessons.includes(slug)) {
         btn.setAttribute('data-completed', 'true');
         btn.querySelector('.btn-text').textContent = 'Completed';
       }

       btn.addEventListener('click', () => {
         if (!completedLessons.includes(slug)) {
           completedLessons.push(slug);
           localStorage.setItem('completedLessons', JSON.stringify(completedLessons));
           btn.setAttribute('data-completed', 'true');
           btn.querySelector('.btn-text').textContent = 'Completed';
         }
       });
     });
   </script>
   ```

5. Verify floating toggle visibility:
   - Should be visible on mobile (< 1024px)
   - Should be hidden on desktop when sidebar is always visible
   - CSS from Phase 5 should already handle this
  </action>
  <verify>
Run `npm run dev` and test:
1. Click "Mark as Complete" on a lesson
2. Refresh page - button should show "Completed"
3. Check localStorage in DevTools - slug should be in completedLessons array
4. On mobile viewport, floating navigator toggle should be visible
  </verify>
  <done>
Mark as Complete button works and persists to localStorage.
Button shows completed state on page reload.
Floating navigator visible on mobile.
Lesson completion integrates with dashboard progress.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` completes without errors (all 73 lessons)
2. Lesson content is readable with ~70ch line length
3. Previous/Next navigation works correctly
4. Mark as Complete persists to localStorage
5. Floating navigator toggle appears on mobile
6. Dark mode works throughout lesson pages
</verification>

<success_criteria>
- LEARN-02 satisfied: Lesson pages with proper reading width and floating navigator
- Content constrained to 60-75ch (70ch) for optimal readability
- Previous/Next navigation enables linear progression
- Completion tracking works via localStorage
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-page-redesigns/06-03-SUMMARY.md`
</output>
