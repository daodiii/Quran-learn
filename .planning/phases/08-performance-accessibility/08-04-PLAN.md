---
phase: 08-performance-accessibility
plan: 04
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - playwright.config.ts
autonomous: false

must_haves:
  truths:
    - "Lighthouse accessibility score is 100 on production build"
    - "Production Lighthouse performance score is 90+ (or bottlenecks documented)"
    - "Screen reader announcement behavior verified by human tester"
  artifacts:
    - path: "playwright.config.ts"
      provides: "Production build configuration for Lighthouse testing"
      contains: "preview"
  key_links:
    - from: "playwright.config.ts"
      to: "npm run preview"
      via: "webServer command runs production preview"
      pattern: "preview"
---

<objective>
Run production Lighthouse audit targeting accessibility score 100, and verify screen reader behavior through manual testing.

Purpose: Validate that all Phase 8 accessibility work achieves a perfect Lighthouse accessibility score on the production build (not dev server which has misleading scores from HMR/dev toolbar). Confirm screen reader announcements work correctly through VoiceOver manual testing.

Output: Lighthouse scores documented, any remaining fixes applied, screen reader behavior confirmed.
</objective>

<execution_context>
@/Users/daodilyas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daodilyas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-performance-accessibility/08-RESEARCH.md
@.planning/phases/08-performance-accessibility/08-01-SUMMARY.md
@.planning/phases/08-performance-accessibility/08-02-SUMMARY.md
@.planning/phases/08-performance-accessibility/08-03-SUMMARY.md

Key files to read before implementing:
@playwright.config.ts
@src/layouts/BaseLayout.astro
</context>

<tasks>

<task type="auto">
  <name>Task 1: Production Lighthouse Audit</name>
  <files>playwright.config.ts</files>
  <action>
**Step A: Build and preview production site**

Run the production build and preview:
```bash
cd /Users/daodilyas/quran-learn
npm run build
```

Then start the preview server in the background:
```bash
npm run preview &
```

Wait for the server to be ready on `http://localhost:4321`.

**Step B: Run Lighthouse CLI on key pages**

Install Lighthouse CLI if not available:
```bash
npx lighthouse --version || npm install -g lighthouse
```

Run Lighthouse on the homepage with accessibility focus:
```bash
npx lighthouse http://localhost:4321/ --only-categories=accessibility,performance --output=json --output-path=./lighthouse-home.json --chrome-flags="--headless --no-sandbox"
```

Run on the quiz page:
```bash
npx lighthouse http://localhost:4321/learn/level-1/quiz/ --only-categories=accessibility,performance --output=json --output-path=./lighthouse-quiz.json --chrome-flags="--headless --no-sandbox"
```

Run on the surah page:
```bash
npx lighthouse http://localhost:4321/surahs/001-al-fatiha/ --only-categories=accessibility,performance --output=json --output-path=./lighthouse-surah.json --chrome-flags="--headless --no-sandbox"
```

**Step C: Parse and report scores**

Extract scores from JSON output:
```bash
node -e "
const fs = require('fs');
['lighthouse-home.json', 'lighthouse-quiz.json', 'lighthouse-surah.json'].forEach(file => {
  try {
    const data = JSON.parse(fs.readFileSync(file, 'utf8'));
    const categories = data.categories;
    console.log(file + ':');
    console.log('  Accessibility: ' + Math.round(categories.accessibility.score * 100));
    console.log('  Performance: ' + Math.round(categories.performance.score * 100));
    console.log('');
  } catch(e) {
    console.log(file + ': Error reading - ' + e.message);
  }
});
"
```

**Step D: Fix accessibility issues if score < 100**

If Lighthouse accessibility score is below 100, read the JSON output to identify failing audits:
```bash
node -e "
const data = JSON.parse(require('fs').readFileSync('lighthouse-home.json', 'utf8'));
const audits = data.audits;
Object.entries(audits).forEach(([id, audit]) => {
  if (audit.score !== null && audit.score < 1) {
    console.log('FAIL:', id, '-', audit.title);
    if (audit.details?.items) {
      audit.details.items.slice(0, 3).forEach(item => {
        console.log('  -', item.node?.snippet || item.element || JSON.stringify(item).slice(0, 100));
      });
    }
  }
});
"
```

Fix any identified issues in the relevant source files. Common Lighthouse accessibility failures:
- Missing alt text on images -> add alt attributes
- Missing form labels -> add `<label>` or aria-label
- Low contrast -> adjust colors (but Phase 4 already achieved WCAG AAA)
- Missing document language -> already has `lang="en"` in BaseLayout
- Missing page title -> already has title in BaseLayout

After fixes, rebuild and re-run Lighthouse to confirm score reaches 100.

**Step E: Clean up**

Remove Lighthouse JSON files (don't commit):
```bash
rm -f lighthouse-home.json lighthouse-quiz.json lighthouse-surah.json
```

Kill the preview server:
```bash
kill %1 2>/dev/null || true
```

Document the final Lighthouse scores in the SUMMARY.
  </action>
  <verify>
1. Production build succeeds (`npm run build`).
2. Lighthouse accessibility score is 100 on at least the homepage.
3. Lighthouse performance score is documented (expected 90+ for static site).
4. Any failing audits have been fixed.
5. Lighthouse JSON files cleaned up.
  </verify>
  <done>Production Lighthouse audit complete. Accessibility score is 100. Performance score documented. Any identified issues fixed.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 8 accessibility implementation:
1. Font preloading for Amiri Regular Arabic and UthmanicHafs (eliminates FOIT)
2. ARIA live regions announcing lesson completion and quiz results
3. Capacitor splash screen lifecycle management
4. Keyboard navigation audit and fixes
5. Comprehensive automated accessibility tests
6. Production Lighthouse audit with accessibility score 100
  </what-built>
  <how-to-verify>
**Screen Reader Testing (VoiceOver on macOS):**

1. Open Terminal: `npm run preview` (in /Users/daodilyas/quran-learn)
2. Open Safari and navigate to http://localhost:4321
3. Enable VoiceOver: Cmd + F5 (or System Preferences > Accessibility > VoiceOver)
4. Navigate through the homepage using VoiceOver:
   - Verify all headings, links, and buttons are announced
   - Verify skip link is announced when focused
5. Navigate to a quiz page: http://localhost:4321/learn/level-1/quiz/
   - Click "Start Quiz" -- verify VoiceOver announces the button
   - Select an answer -- verify VoiceOver announces "Correct" or "Incorrect"
   - Complete the quiz -- verify VoiceOver announces final score
6. Check RTL content on surah page: http://localhost:4321/surahs/001-al-fatiha/
   - Verify Arabic text is announced correctly by VoiceOver
7. Disable VoiceOver: Cmd + F5

**Keyboard Navigation Check:**

1. Navigate http://localhost:4321 using ONLY keyboard (Tab, Enter, Escape, Arrow keys)
2. Verify visible focus indicator on every interactive element
3. Tab through entire homepage -- no keyboard traps
4. On quiz page, verify quiz can be completed entirely via keyboard

**Visual Check:**

1. Load http://localhost:4321 -- Arabic fonts should appear immediately (no invisible text flash)
2. Switch to dark mode -- all text remains readable
  </how-to-verify>
  <resume-signal>Type "approved" if screen reader, keyboard, and visual checks pass. Otherwise describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. Production Lighthouse accessibility score is 100
2. Production Lighthouse performance score is 90+ (or TBT bottleneck documented as dev-only)
3. VoiceOver screen reader announces all interactive elements
4. ARIA live regions announce progress changes
5. Keyboard navigation reaches all interactive elements
6. No FOIT observed on page load
</verification>

<success_criteria>
- Lighthouse accessibility: 100 on production build
- Lighthouse performance: 90+ on production build (or documented reason if lower)
- VoiceOver announces quiz answers, completion, and lesson progress
- Keyboard-only navigation verified by human tester
- No invisible text flash during font loading
</success_criteria>

<output>
After completion, create `.planning/phases/08-performance-accessibility/08-04-SUMMARY.md`
</output>
