---
phase: 08-performance-accessibility
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/scripts/capacitor-init.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Capacitor app shows splash screen during initialization and hides when ready"
    - "Total JavaScript bundle is under 50KB in production build"
    - "Bundle composition is visualized and documented"
  artifacts:
    - path: "src/scripts/capacitor-init.ts"
      provides: "Capacitor splash screen lifecycle management"
      contains: "SplashScreen"
    - path: "package.json"
      provides: "rollup-plugin-visualizer in devDependencies"
      contains: "rollup-plugin-visualizer"
  key_links:
    - from: "src/scripts/capacitor-init.ts"
      to: "@capacitor/splash-screen"
      via: "import SplashScreen API"
      pattern: "SplashScreen"
    - from: "src/layouts/BaseLayout.astro"
      to: "src/scripts/capacitor-init.ts"
      via: "import initCapacitor (already wired)"
      pattern: "initCapacitor"
---

<objective>
Implement Capacitor splash screen lifecycle control and verify JavaScript bundle size is under 50KB.

Purpose: Ensure the mobile app launches smoothly with splash screen visible during initialization (font loading, theme setup, localStorage read) and hidden when ready. Verify and document bundle size to prevent regression.

Output: Fully implemented capacitor-init.ts (replacing stub), bundle size analysis with rollup-plugin-visualizer.
</objective>

<execution_context>
@/Users/daodilyas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daodilyas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-performance-accessibility/08-RESEARCH.md

Key files to read before implementing:
@src/scripts/capacitor-init.ts
@src/layouts/BaseLayout.astro
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Capacitor Splash Screen Lifecycle</name>
  <files>src/scripts/capacitor-init.ts</files>
  <action>
Replace the stub in `src/scripts/capacitor-init.ts` with a proper Capacitor initialization that controls the splash screen lifecycle. The current file is a no-op stub:

```typescript
export function initCapacitor() {
  // No-op for now
}
```

Replace with:

```typescript
import { SplashScreen } from '@capacitor/splash-screen';
import { Capacitor } from '@capacitor/core';

/**
 * Initialize Capacitor mobile app.
 * Controls splash screen visibility during critical initialization:
 * 1. Keeps splash screen visible during font loading and theme setup
 * 2. Hides splash screen when app is ready for interaction
 * Target: < 2 seconds from tap to interactive on iOS
 */
export async function initCapacitor(): Promise<void> {
  // Only run on native platforms (iOS/Android)
  if (!Capacitor.isNativePlatform()) {
    return;
  }

  try {
    // Keep splash screen visible during initialization
    await SplashScreen.show({
      autoHide: false,
    });

    // Critical initialization tasks:
    // 1. Theme preference from localStorage
    const theme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', theme);

    // 2. Wait for critical fonts to be ready
    // (font-display: swap shows fallback immediately, this waits for final fonts)
    await document.fonts.ready;

    // 3. Hide splash screen with smooth fade
    await SplashScreen.hide({
      fadeOutDuration: 300,
    });
  } catch (error) {
    console.error('Capacitor initialization error:', error);
    // Always hide splash screen on error to prevent user stuck on splash
    try {
      await SplashScreen.hide();
    } catch {
      // If hide also fails, nothing more we can do
    }
  }
}
```

IMPORTANT: The function signature must remain `export async function initCapacitor(): Promise<void>` (or `export function initCapacitor()` with async inside) to maintain compatibility with BaseLayout.astro which calls `initCapacitor()` without await. Since BaseLayout.astro already imports and calls this function, the export name MUST remain `initCapacitor`.

Check that `@capacitor/splash-screen` and `@capacitor/core` are already in package.json dependencies (they are: @capacitor/splash-screen 8.0.0, @capacitor/core 8.0.2).
  </action>
  <verify>
1. Run `npm run build` -- build must succeed.
2. Verify `src/scripts/capacitor-init.ts` contains `SplashScreen.show`, `SplashScreen.hide`, and `Capacitor.isNativePlatform()`.
3. Verify the export function name is `initCapacitor` (matching BaseLayout.astro import).
  </verify>
  <done>capacitor-init.ts implements splash screen lifecycle: show during init, hide after fonts ready and theme set. Error handling prevents user stuck on splash. Function signature compatible with existing BaseLayout import.</done>
</task>

<task type="auto">
  <name>Task 2: Bundle Size Verification with Visualizer</name>
  <files>package.json</files>
  <action>
**Step A: Install rollup-plugin-visualizer**

Run: `npm install --save-dev rollup-plugin-visualizer`

This is the only new dependency for Phase 8. Verify it appears in devDependencies in package.json.

**Step B: Run production build and measure bundle**

Run: `npm run build`

After build completes, measure the total JavaScript output:

```bash
# Find all JS files in dist and sum their sizes
find dist/_astro -name "*.js" -exec wc -c {} + 2>/dev/null
# Also check total dist size
du -sh dist/
```

The current build is approximately 4.4KB of JavaScript (from Phase 7 research). The target is under 50KB total JavaScript. Document the actual measured size.

**Step C: Generate bundle visualization (optional but recommended)**

Note: rollup-plugin-visualizer requires configuration in astro.config.mjs to generate the visualization HTML. Since no astro.config.mjs exists in this project (Astro defaults are used), create one if needed:

Check if `astro.config.mjs` exists. If not, create it at the project root:

```javascript
import { defineConfig } from 'astro/config';
import tailwindcss from '@tailwindcss/vite';
import mdx from '@astrojs/mdx';

export default defineConfig({
  integrations: [mdx()],
  vite: {
    plugins: [
      tailwindcss(),
    ],
  },
});
```

IMPORTANT: If astro.config.mjs already exists, do NOT overwrite it. Only add the visualizer temporarily for analysis.

For now, the bundle size measurement via file system is sufficient since the project is ~4.4KB JS (well under 50KB). The rollup-plugin-visualizer install is primarily for future regression prevention. Do NOT add it to astro.config.mjs permanently -- it's a dev analysis tool to run on-demand.

Add a script to package.json:
```json
"analyze": "npx astro build && echo 'Bundle analysis complete. Check dist/_astro/ for JS files.'"
```
  </action>
  <verify>
1. `npm ls rollup-plugin-visualizer` confirms it's installed in devDependencies.
2. `npm run build` succeeds.
3. Measure total JS in dist/_astro/: `find dist/_astro -name "*.js" -exec wc -c {} +` -- total must be under 50KB (51,200 bytes).
4. Document the measured bundle size in the summary.
  </verify>
  <done>rollup-plugin-visualizer installed as devDependency. Production build succeeds. Total JavaScript bundle measured and confirmed under 50KB. package.json has "analyze" script for future use.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors
2. capacitor-init.ts contains SplashScreen.show/hide with proper error handling
3. rollup-plugin-visualizer in devDependencies
4. Total JS bundle in dist/_astro/ is under 50KB
5. BaseLayout.astro still imports and calls initCapacitor() correctly (no breaking changes)
</verification>

<success_criteria>
- Capacitor splash screen lifecycle fully implemented (show during init, hide when ready)
- Error handling prevents users getting stuck on splash screen
- rollup-plugin-visualizer available as dev tool
- Production JavaScript bundle confirmed under 50KB
- No breaking changes to existing imports
</success_criteria>

<output>
After completion, create `.planning/phases/08-performance-accessibility/08-02-SUMMARY.md`
</output>
