---
phase: 08-performance-accessibility
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/styles/global.css
  - tests/accessibility.spec.ts
autonomous: true

must_haves:
  truths:
    - "Tab key reaches every interactive element on every page without getting trapped"
    - "Focus indicators are visible with 3:1 contrast ratio on all interactive elements"
    - "Skip link works correctly on all pages"
    - "All interactive elements have proper ARIA labels"
  artifacts:
    - path: "src/styles/global.css"
      provides: "Enhanced focus-visible styles and any keyboard navigation fixes"
      contains: "focus-visible"
    - path: "tests/accessibility.spec.ts"
      provides: "Comprehensive accessibility tests covering all key pages"
      contains: "axe"
  key_links:
    - from: "tests/accessibility.spec.ts"
      to: "src/layouts/BaseLayout.astro"
      via: "Tests verify accessibility of pages rendered with BaseLayout"
      pattern: "page.goto"
    - from: "src/styles/global.css"
      to: "src/layouts/BaseLayout.astro"
      via: "Global styles imported by BaseLayout"
      pattern: "global.css"
---

<objective>
Audit and complete keyboard navigation across all pages, then run comprehensive automated accessibility tests to verify Lighthouse-ready accessibility.

Purpose: Ensure every interactive element is keyboard-accessible with visible focus indicators, and automated tests verify WCAG compliance across all key pages (homepage, learn, quiz, surah, resources) in both light and dark modes.

Output: Any CSS fixes for keyboard navigation gaps, expanded axe-core test suite covering all main pages.
</objective>

<execution_context>
@/Users/daodilyas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daodilyas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-performance-accessibility/08-RESEARCH.md
@.planning/phases/08-performance-accessibility/08-01-SUMMARY.md

Key files to read before implementing:
@src/styles/global.css
@src/layouts/BaseLayout.astro
@src/scripts/navigation.ts
@tests/accessibility.spec.ts
@src/components/Header.astro
@src/components/Footer.astro
@src/components/Quiz.astro
</context>

<tasks>

<task type="auto">
  <name>Task 1: Keyboard Navigation Audit & Fix</name>
  <files>src/styles/global.css</files>
  <action>
Read through all interactive components and pages to audit keyboard navigation completeness. Check each of these areas:

**1. Focus indicator consistency (global.css)**

Read the current `:focus-visible` rule in global.css (around line 425). Verify:
- It applies to ALL interactive elements (not just some)
- The outline uses `var(--border-focus)` which is #0D7377 (teal)
- outline-offset is 2px
- Contrast ratio of focus indicator against backgrounds is at least 3:1

If the current `*:focus-visible` rule is insufficient, enhance it. Ensure it doesn't conflict with existing component-specific focus styles.

**2. Skip link verification**

The skip link already exists in BaseLayout.astro (`<a href="#main-content" class="skip-link">Skip to main content</a>`) with styles in global.css. Verify:
- It appears when focused (top: 0 on :focus)
- It targets `#main-content` which exists as the main element's id
- It works in both LTR and RTL modes (check if `left` should be `inset-inline-start` for RTL)

If the skip link uses `left: var(--space-md)` instead of `inset-inline-start`, update to logical property for RTL compatibility:
```css
.skip-link {
  inset-inline-start: var(--space-md);  /* Replace left: */
}
```

**3. Quiz keyboard accessibility**

Read Quiz.astro's client-side script. Verify:
- Quiz options can be selected with Enter/Space keys
- "Next Question" button is focusable after answering
- "Start Quiz" button is keyboard accessible
- Results screen actions (retake, continue) are keyboard accessible

If quiz options are clickable divs instead of buttons, they need `role="button"` and `tabindex="0"` with keyboard event handlers. Check the actual implementation first.

**4. Header/Footer keyboard accessibility**

Read Header.astro and Footer.astro. Verify:
- All links and buttons are natively focusable
- Theme toggle button has aria-label
- Navigator toggle button has aria-label and aria-expanded

Make any necessary CSS fixes in global.css. Do NOT modify fonts.css (PROTECTED).
  </action>
  <verify>
1. `npm run build` succeeds.
2. Verify skip-link uses CSS logical property for RTL: grep for `inset-inline-start` in global.css.
3. Verify `:focus-visible` rule exists with proper outline styling.
4. Start dev server and manually Tab through homepage, learn page, and quiz page using keyboard only -- all interactive elements should receive visible focus.
  </verify>
  <done>All interactive elements keyboard-accessible. Focus indicators use 3:1 contrast. Skip link works in LTR and RTL. Quiz navigation keyboard-complete. No keyboard traps.</done>
</task>

<task type="auto">
  <name>Task 2: Comprehensive Accessibility Test Suite</name>
  <files>tests/accessibility.spec.ts</files>
  <action>
Expand the existing accessibility.spec.ts to cover ALL key pages in both light and dark modes. The current tests only cover `/test/cards/`, `/test/components/`, and `/surahs/001-al-fatiha/`.

Add the following test sections to the EXISTING file (append, don't replace existing tests):

**1. Full-page WCAG scans for key pages:**

```typescript
test.describe('Full Page Accessibility - All Key Pages', () => {
  const pages = [
    { name: 'Homepage', url: '/' },
    { name: 'Learn Dashboard', url: '/learn/' },
    { name: 'Level 1 Quiz', url: '/learn/level-1/quiz/' },
    { name: 'Surah Al-Fatiha', url: '/surahs/001-al-fatiha/' },
    { name: 'Resources', url: '/resources/' },
  ];

  for (const { name, url } of pages) {
    test(`${name} passes full axe scan in light mode`, async ({ page }) => {
      await page.goto(url);
      await page.waitForLoadState('networkidle');

      const results = await new AxeBuilder({ page })
        .withTags(['wcag2a', 'wcag2aa', 'wcag21a', 'wcag21aa'])
        .analyze();

      expect(results.violations).toEqual([]);
    });

    test(`${name} passes full axe scan in dark mode`, async ({ page }) => {
      await page.goto(url);
      await page.waitForLoadState('networkidle');
      await enableDarkMode(page);

      const results = await new AxeBuilder({ page })
        .withTags(['wcag2a', 'wcag2aa', 'wcag21a', 'wcag21aa'])
        .analyze();

      expect(results.violations).toEqual([]);
    });
  }
});
```

**2. ARIA live region verification:**

```typescript
test.describe('ARIA Live Regions', () => {
  test('AriaLiveRegion component is present on homepage', async ({ page }) => {
    await page.goto('/');
    await page.waitForLoadState('networkidle');

    const announcer = page.locator('[data-progress-announcer]');
    await expect(announcer).toHaveCount(1);
    await expect(announcer).toHaveAttribute('role', 'status');
    await expect(announcer).toHaveAttribute('aria-live', 'polite');
    await expect(announcer).toHaveAttribute('aria-atomic', 'true');
  });

  test('AriaLiveRegion component is present on quiz page', async ({ page }) => {
    await page.goto('/learn/level-1/quiz/');
    await page.waitForLoadState('networkidle');

    const announcer = page.locator('[data-progress-announcer]');
    await expect(announcer).toHaveCount(1);
    await expect(announcer).toHaveAttribute('role', 'status');
    await expect(announcer).toHaveAttribute('aria-live', 'polite');
  });
});
```

**3. Keyboard navigation tests:**

```typescript
test.describe('Keyboard Navigation', () => {
  test('Skip link is present and functional', async ({ page }) => {
    await page.goto('/');
    await page.waitForLoadState('networkidle');

    // Skip link should exist
    const skipLink = page.locator('.skip-link');
    await expect(skipLink).toHaveCount(1);
    await expect(skipLink).toHaveAttribute('href', '#main-content');

    // Main content target should exist
    const mainContent = page.locator('#main-content');
    await expect(mainContent).toHaveCount(1);
  });

  test('Tab navigation reaches key interactive elements on homepage', async ({ page }) => {
    await page.goto('/');
    await page.waitForLoadState('networkidle');

    // Tab through and verify focus reaches interactive elements
    await page.keyboard.press('Tab'); // Skip link
    await page.keyboard.press('Tab'); // First header element

    // Verify something received focus
    const focusedTag = await page.evaluate(() => document.activeElement?.tagName);
    expect(['A', 'BUTTON', 'INPUT']).toContain(focusedTag);
  });

  test('Focus visible indicator is present', async ({ page }) => {
    await page.goto('/');
    await page.waitForLoadState('networkidle');

    // Tab to first interactive element
    await page.keyboard.press('Tab');
    await page.keyboard.press('Tab');

    // Check that focused element has visible outline
    const outline = await page.evaluate(() => {
      const el = document.activeElement;
      if (!el) return 'none';
      const style = window.getComputedStyle(el);
      return style.outlineStyle;
    });

    expect(outline).not.toBe('none');
  });
});
```

**4. Font preload verification:**

```typescript
test.describe('Font Loading', () => {
  test('Critical fonts are preloaded', async ({ page }) => {
    await page.goto('/');
    await page.waitForLoadState('networkidle');

    // Check for font preload links
    const preloadLinks = page.locator('link[rel="preload"][as="font"]');
    const count = await preloadLinks.count();
    expect(count).toBe(2); // Amiri Regular Arabic + UthmanicHafs

    // Verify crossorigin attribute
    for (let i = 0; i < count; i++) {
      const link = preloadLinks.nth(i);
      await expect(link).toHaveAttribute('crossorigin', '');
    }
  });
});
```

IMPORTANT: Add these tests by APPENDING to the existing file. Do NOT remove or modify existing test blocks. The existing `enableDarkMode` helper function should be reused.

Run the test suite to check for failures. If any axe violations are found on specific pages, document them as issues but do NOT modify the test expectations -- fix the source HTML/CSS instead. If a page doesn't exist in the build (404), skip that test with a comment.
  </action>
  <verify>
1. Run `npm run build` to ensure production build succeeds.
2. Run `npx playwright test tests/accessibility.spec.ts` -- all tests should pass or have documented reasons for any failures.
3. Verify tests cover: homepage, learn dashboard, quiz, surah page, resources page.
4. Verify ARIA live region tests exist and pass.
5. Verify keyboard navigation tests exist and pass.
  </verify>
  <done>Accessibility test suite expanded to cover all 5 key pages in light and dark modes. ARIA live region presence verified. Keyboard navigation tested. Font preload verification included. All tests pass (or failures documented with fixes applied).</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. `npx playwright test tests/accessibility.spec.ts` passes (run against production build via `npm run preview`)
3. Skip link uses CSS logical properties for RTL
4. All key pages pass axe-core WCAG A + AA scans
5. ARIA live region verified on every page
6. Keyboard focus indicators visible
</verification>

<success_criteria>
- All interactive elements reachable via keyboard Tab navigation
- Focus indicators use :focus-visible with 3:1 contrast
- Skip link functional in both LTR and RTL
- axe-core tests pass for all 5 key pages in both light and dark modes
- ARIA live region present and correctly attributed on all pages
- Font preloads verified in tests
</success_criteria>

<output>
After completion, create `.planning/phases/08-performance-accessibility/08-03-SUMMARY.md`
</output>
