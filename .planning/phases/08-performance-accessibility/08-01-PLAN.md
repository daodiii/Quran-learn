---
phase: 08-performance-accessibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/layouts/BaseLayout.astro
  - src/components/AriaLiveRegion.astro
  - src/scripts/progress-announcer.ts
  - src/components/Quiz.astro
  - src/lib/progress.ts
autonomous: true

must_haves:
  truths:
    - "Arabic fonts appear immediately without invisible text flash (FOIT eliminated)"
    - "Screen reader announces lesson completion when lesson is marked done"
    - "Screen reader announces quiz results when quiz is submitted"
    - "RTL mode screen reader announcements work correctly"
  artifacts:
    - path: "src/layouts/BaseLayout.astro"
      provides: "Font preload links in <head> for Amiri Regular Arabic and UthmanicHafs"
      contains: "rel=\"preload\""
    - path: "src/components/AriaLiveRegion.astro"
      provides: "Reusable ARIA live region component for screen reader announcements"
      contains: "aria-live=\"polite\""
    - path: "src/scripts/progress-announcer.ts"
      provides: "JavaScript utility to announce progress changes to screen readers"
      exports: ["announceProgress"]
  key_links:
    - from: "src/components/Quiz.astro"
      to: "src/scripts/progress-announcer.ts"
      via: "import and call announceProgress on quiz completion"
      pattern: "announceProgress"
    - from: "src/lib/progress.ts"
      to: "src/scripts/progress-announcer.ts"
      via: "announce after markLessonComplete"
      pattern: "announceProgress"
    - from: "src/layouts/BaseLayout.astro"
      to: "src/components/AriaLiveRegion.astro"
      via: "component inclusion before closing body"
      pattern: "AriaLiveRegion"
---

<objective>
Add font preloading to eliminate FOIT and implement ARIA live regions for screen reader progress announcements.

Purpose: Ensure Arabic fonts load instantly without invisible text flash, and enable screen readers (NVDA, JAWS, VoiceOver) to announce progress state changes for lesson completion and quiz results.

Output: Font preload links in BaseLayout head, AriaLiveRegion component, progress-announcer.ts utility, and integration into Quiz and progress tracking flows.
</objective>

<execution_context>
@/Users/daodilyas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daodilyas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-performance-accessibility/08-RESEARCH.md

Key files to read before implementing:
@src/layouts/BaseLayout.astro
@src/styles/fonts.css
@src/components/Quiz.astro
@src/lib/progress.ts
@src/scripts/navigation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Font Preload Links to BaseLayout</name>
  <files>src/layouts/BaseLayout.astro</files>
  <action>
Add two `<link rel="preload">` tags in the `<head>` section of BaseLayout.astro, BEFORE the inline theme script. Preload only the two critical above-the-fold fonts:

1. Amiri Regular Arabic (body text): `/fonts/amiri-regular-arabic.woff2`
2. UthmanicHafs (Quranic text): `/fonts/UthmanicHafs.woff2`

Both links MUST include:
- `rel="preload"`
- `href` pointing to the font path
- `as="font"`
- `type="font/woff2"`
- `crossorigin` attribute (required even for same-origin fonts)

Place them after the favicon link and before the inline theme script. Do NOT preload other font variants (bold, italic) -- they load on-demand via font-display: swap (already configured in fonts.css which is PROTECTED/IMMUTABLE -- do NOT modify fonts.css).

DO NOT add any other preload links. Only these 2 fonts.
  </action>
  <verify>
Run `npm run build` in the project root. Inspect `dist/index.html` and confirm the two `<link rel="preload">` tags appear in the `<head>` section with correct paths and attributes. Verify fonts.css was NOT modified.
  </verify>
  <done>BaseLayout.astro contains exactly 2 font preload links (Amiri Regular Arabic + UthmanicHafs) with crossorigin attribute. fonts.css unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Create AriaLiveRegion Component and Progress Announcer</name>
  <files>
    src/components/AriaLiveRegion.astro
    src/scripts/progress-announcer.ts
    src/layouts/BaseLayout.astro
    src/components/Quiz.astro
    src/lib/progress.ts
  </files>
  <action>
**Step A: Create AriaLiveRegion.astro component**

Create `src/components/AriaLiveRegion.astro` with a visually-hidden div that acts as a screen reader announcement region:

```astro
---
// AriaLiveRegion.astro - Screen reader announcement region
// Uses aria-live="polite" with role="status" for NVDA/JAWS/VoiceOver compatibility
// See: https://adrianroselli.com/2026/01/live-region-support.html
---
<div
  role="status"
  aria-live="polite"
  aria-atomic="true"
  class="sr-only"
  data-progress-announcer
>
</div>

<style>
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
</style>
```

Use `aria-live="polite"` (NOT assertive -- JAWS treats all as polite anyway, per Adrian Roselli testing January 2026).

**Step B: Create progress-announcer.ts**

Create `src/scripts/progress-announcer.ts`:

```typescript
/**
 * Announce progress changes to screen readers via ARIA live region.
 * Uses [data-progress-announcer] element rendered by AriaLiveRegion.astro.
 */
export function announceProgress(message: string): void {
  const announcer = document.querySelector('[data-progress-announcer]');
  if (!announcer) return;

  // Set announcement text
  announcer.textContent = message;

  // Clear after 1 second to allow re-announcement of same message
  setTimeout(() => {
    announcer.textContent = '';
  }, 1000);
}
```

**Step C: Add AriaLiveRegion to BaseLayout.astro**

Import and include AriaLiveRegion component in BaseLayout.astro, placed just before the closing `</body>` tag (after Footer, before the script tag). Add the import at the top of the frontmatter section:

```astro
import AriaLiveRegion from '../components/AriaLiveRegion.astro';
```

And in the body:
```html
  <Footer />
  <AriaLiveRegion />
  <script>
```

**Step D: Wire announceProgress into Quiz.astro**

In the Quiz.astro component's client-side `<script>` section, import announceProgress and call it at two key moments:
1. When the quiz is completed (after results are shown): `announceProgress(\`Quiz completed. Score: \${score} out of \${total}. \${passed ? 'You passed!' : 'Try again.'}\`)`
2. When an answer is selected (after feedback): `announceProgress(\`\${isCorrect ? 'Correct' : 'Incorrect'}. \${currentQuestion + 1} of \${total} answered.\`)`

Read Quiz.astro fully first to find the exact locations in the client-side script where quiz completion and answer selection happen.

**Step E: Wire announceProgress into progress.ts**

In `src/lib/progress.ts`, add an import for announceProgress and call it inside `markLessonComplete()` after successful save:

```typescript
import { announceProgress } from '../scripts/progress-announcer';
```

After `data.completedLessons.push(lessonSlug)` and the successful save:
```typescript
announceProgress(`Lesson completed. ${data.completedLessons.length} lessons finished.`);
```

Wrap the announceProgress call in a try-catch so it never breaks progress tracking if the DOM element is missing (SSR context).

IMPORTANT: Do NOT use `aria-live="assertive"`. Always use `"polite"`.
  </action>
  <verify>
1. Run `npm run build` -- build must succeed without errors.
2. Inspect the built HTML output to confirm the `[data-progress-announcer]` div with `role="status"` and `aria-live="polite"` appears before `</body>`.
3. Verify progress-announcer.ts exports `announceProgress` function.
4. Grep for `announceProgress` in Quiz.astro and progress.ts to confirm integration.
  </verify>
  <done>AriaLiveRegion component renders in BaseLayout. progress-announcer.ts exports announceProgress(). Quiz.astro announces quiz results and answer feedback. progress.ts announces lesson completion. All use aria-live="polite".</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors
2. Built HTML contains 2 font preload links in head
3. Built HTML contains [data-progress-announcer] div with role="status" and aria-live="polite"
4. `grep -r "announceProgress" src/` shows usage in Quiz.astro, progress.ts, and definition in progress-announcer.ts
5. fonts.css file is unchanged (PROTECTED)
</verification>

<success_criteria>
- Font preload links for Amiri Regular Arabic and UthmanicHafs present in all page heads
- AriaLiveRegion component included in BaseLayout (renders on every page)
- Screen reader announcements wired for: quiz answer feedback, quiz completion, lesson completion
- All announcements use aria-live="polite" (never assertive)
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/08-performance-accessibility/08-01-SUMMARY.md`
</output>
