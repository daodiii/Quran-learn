---
phase: 04-dark-mode-polish
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/styles/global.css
  - tests/accessibility.spec.ts
autonomous: false

must_haves:
  truths:
    - "Arabic diacritical marks (harakat) clearly visible in dark mode"
    - "UthmanicHafs font readable without eye strain in dark mode"
    - "Font weight adjusted for dark mode optical compensation"
    - "Visual regression baselines capture Arabic text in dark mode"
  artifacts:
    - path: "src/styles/global.css"
      provides: "Dark mode font weight adjustments for Arabic text"
      contains: "[data-theme=\"dark\"] .arabic"
    - path: "tests/accessibility.spec.ts-snapshots"
      provides: "Visual regression baselines for Arabic dark mode"
  key_links:
    - from: "src/styles/global.css"
      to: "[data-theme=\"dark\"]"
      via: "CSS selector"
      pattern: "\\[data-theme=\"dark\"\\].*\\.arabic"
    - from: "tests/accessibility.spec.ts"
      to: "/surahs/001-al-fatiha/"
      via: "visual regression test"
      pattern: "toHaveScreenshot.*quran.*dark"
---

<objective>
Implement font weight optical compensation for Arabic text in dark mode and establish visual regression baselines for diacritical mark visibility.

Purpose: Light text on dark backgrounds appears thinner due to antialiasing. Research recommends increasing font-weight from 400 to 500 for dark mode. This plan adjusts Arabic typography styling and creates visual baselines to ensure harakat (diacritical marks) remain visible.

Output: Updated global.css with dark mode Arabic font weight rules, visual regression baselines for Quranic text, and human-verified readability.
</objective>

<execution_context>
@/Users/daodilyas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daodilyas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-dark-mode-polish/04-RESEARCH.md
@src/styles/global.css
@tests/accessibility.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dark mode font weight adjustments for Arabic text</name>
  <files>src/styles/global.css</files>
  <action>
Add CSS rules for Arabic text font weight in dark mode. Insert these rules in the `@layer base` section, after the existing `.arabic`, `.arabic-lg`, `.arabic-xl` class definitions (around line 365):

```css
/* Dark mode font weight optical compensation for Arabic text */
/* Light-on-dark text appears thinner due to antialiasing - increase weight */
[data-theme="dark"] .arabic,
[data-theme="dark"] .arabic-lg,
[data-theme="dark"] .arabic-xl {
  font-weight: 500;
}

/* Note: UthmanicHafs font may only support weight 400.
   If font doesn't support 500, browser will synthesize or fallback.
   Visual regression tests will validate actual rendering. */
```

Also add dark mode specific styling for Arabic text in tables and other contexts:

```css
[data-theme="dark"] .word-analysis-table .arabic-cell {
  font-weight: 500;
}

[data-theme="dark"] .quiz-option.arabic-option {
  font-weight: 500;
}
```

Research note: If UthmanicHafs doesn't have weight 500 available, browsers will either:
1. Use the closest available weight (400)
2. Synthesize a bold variant (faux-bold)

Both outcomes are acceptable - visual regression tests will validate the actual appearance. If weight 500 causes issues (faux-bold looks bad), we can fallback to alternative approaches in a future iteration:
- text-stroke: 0.2px currentColor (subtle thickening)
- text-shadow: 0 0 0.2px currentColor (similar effect)
  </action>
  <verify>
```bash
# Verify CSS syntax by building
npm run build

# Check that rules were added
grep -A5 '\[data-theme="dark"\] .arabic' src/styles/global.css
```
  </verify>
  <done>
- global.css contains dark mode font-weight rules for .arabic, .arabic-lg, .arabic-xl
- CSS builds without syntax errors
- Rules target correct selectors with [data-theme="dark"] prefix
  </done>
</task>

<task type="auto">
  <name>Task 2: Create visual regression tests for Arabic diacritical marks</name>
  <files>tests/accessibility.spec.ts</files>
  <action>
Add visual regression tests to tests/accessibility.spec.ts for validating Arabic diacritical mark visibility:

Add new test describe block `'Arabic Diacritical Marks Visibility'`:

```typescript
test.describe('Arabic Diacritical Marks Visibility', () => {
  test('Quranic text with harakat visible in dark mode', async ({ page }) => {
    await page.setViewportSize({ width: 1200, height: 800 });
    await page.goto('/surahs/001-al-fatiha/');
    await page.waitForLoadState('networkidle');

    // Enable dark mode
    await page.evaluate(() => {
      document.documentElement.setAttribute('data-theme', 'dark');
    });
    await page.waitForTimeout(300);

    // Target main Quranic text with UthmanicHafs font
    const arabicText = page.locator('.arabic-xl').first();

    // Visual regression - will capture harakat marks
    await expect(arabicText).toHaveScreenshot('quran-text-dark-harakat.png', {
      maxDiffPixels: 100
    });
  });

  test('Quranic text in light mode for comparison', async ({ page }) => {
    await page.setViewportSize({ width: 1200, height: 800 });
    await page.goto('/surahs/001-al-fatiha/');
    await page.waitForLoadState('networkidle');

    // Light mode (default)
    const arabicText = page.locator('.arabic-xl').first();

    await expect(arabicText).toHaveScreenshot('quran-text-light-harakat.png', {
      maxDiffPixels: 100
    });
  });

  test('SurahCard Arabic names in dark mode', async ({ page }) => {
    await page.goto('/test/cards/');
    await page.waitForLoadState('networkidle');

    await page.evaluate(() => {
      document.documentElement.setAttribute('data-theme', 'dark');
    });
    await page.waitForTimeout(300);

    const surahSection = page.getByTestId('surah-card-section');
    await expect(surahSection).toHaveScreenshot('surah-cards-dark-arabic.png', {
      maxDiffPixels: 100
    });
  });

  test('LessonCard Arabic titles in dark mode', async ({ page }) => {
    await page.goto('/test/cards/');
    await page.waitForLoadState('networkidle');

    await page.evaluate(() => {
      document.documentElement.setAttribute('data-theme', 'dark');
    });
    await page.waitForTimeout(300);

    const lessonSection = page.getByTestId('lesson-card-section');
    await expect(lessonSection).toHaveScreenshot('lesson-cards-dark-arabic.png', {
      maxDiffPixels: 100
    });
  });
});
```

Add test for font-weight verification:

```typescript
test.describe('Dark Mode Font Weight', () => {
  test('Arabic text has increased font-weight in dark mode', async ({ page }) => {
    await page.goto('/test/cards/');
    await page.waitForLoadState('networkidle');

    // Get light mode weight
    const lightWeight = await page.locator('.lesson-title-arabic').first().evaluate((el) => {
      return window.getComputedStyle(el).fontWeight;
    });

    // Enable dark mode
    await page.evaluate(() => {
      document.documentElement.setAttribute('data-theme', 'dark');
    });
    await page.waitForTimeout(300);

    // Get dark mode weight
    const darkWeight = await page.locator('.lesson-title-arabic').first().evaluate((el) => {
      return window.getComputedStyle(el).fontWeight;
    });

    // Dark mode should have equal or higher weight
    expect(parseInt(darkWeight)).toBeGreaterThanOrEqual(parseInt(lightWeight));
  });
});
```
  </action>
  <verify>
```bash
# Run visual regression tests (will create baselines on first run)
npm run test:a11y -- --update-snapshots

# Check that snapshot files were created
ls tests/accessibility.spec.ts-snapshots/
```
  </verify>
  <done>
- Visual regression tests added for Arabic diacritical marks
- Tests cover: Quranic text, SurahCard names, LessonCard titles
- Font-weight verification test confirms dark mode styling applies
- Snapshot baselines captured for future regression detection
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of Arabic readability in dark mode</name>
  <what-built>
Dark mode font weight adjustments for Arabic text and visual regression baselines. The CSS now increases font-weight from 400 to 500 for Arabic text classes in dark mode, compensating for the optical thinning effect of light-on-dark text rendering.
  </what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`

2. Open browser to http://localhost:4321/surahs/001-al-fatiha/

3. Toggle dark mode using the theme button in the header (or add `?theme=dark` to URL if toggle doesn't exist)

4. Verify Arabic readability:
   - [ ] Diacritical marks (harakat - the small marks above/below letters) are clearly visible
   - [ ] Text doesn't appear "washed out" or overly thin
   - [ ] No eye strain when reading for a few seconds
   - [ ] UthmanicHafs font renders properly (no faux-bold artifacts)

5. Navigate to http://localhost:4321/test/cards/

6. In dark mode, verify:
   - [ ] SurahCard Arabic names are readable
   - [ ] LessonCard Arabic titles are visible
   - [ ] Progress indicators have proper contrast
   - [ ] All cards remain functional and visually appealing

7. Compare light vs dark mode:
   - [ ] Both modes have readable Arabic text
   - [ ] Dark mode text is not noticeably thicker (indicates faux-bold issue)
   - [ ] Contrast feels appropriate for extended reading

If issues found, describe:
- Which elements have problems
- What the issue looks like (too thin, too thick, wrong color, etc.)
  </how-to-verify>
  <resume-signal>Type "approved" if Arabic text is readable in dark mode, or describe specific issues that need fixing</resume-signal>
</task>

</tasks>

<verification>
Run complete test suite to verify dark mode polish:

```bash
# Start dev server
npm run dev &

# Run accessibility tests with updated snapshots
npm run test:a11y

# Run all tests
npx playwright test tests/

# Verify no contrast violations
npm run test:a11y -- --grep "contrast"
```

Expected: All tests pass, visual baselines captured, human verification confirms readability.
</verification>

<success_criteria>
1. global.css contains dark mode font-weight rules for Arabic text
2. Visual regression tests capture Arabic text in dark mode
3. Font-weight verification test passes
4. Snapshot baselines created for future regression detection
5. Human verification confirms Arabic diacritical marks are visible
6. No eye strain reported when reading Arabic in dark mode
7. All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-dark-mode-polish/04-02-SUMMARY.md`
</output>
