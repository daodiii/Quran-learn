---
phase: 04-dark-mode-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tests/accessibility.spec.ts
autonomous: true

must_haves:
  truths:
    - "Automated contrast tests validate WCAG AAA (7:1) compliance"
    - "axe-core accessibility tests run against dark mode pages"
    - "All existing pages pass WCAG AAA contrast validation in dark mode"
  artifacts:
    - path: "tests/accessibility.spec.ts"
      provides: "Automated WCAG AAA accessibility tests with axe-core"
      min_lines: 80
    - path: "package.json"
      provides: "@axe-core/playwright dependency"
      contains: "@axe-core/playwright"
  key_links:
    - from: "tests/accessibility.spec.ts"
      to: "@axe-core/playwright"
      via: "import AxeBuilder"
      pattern: "import.*AxeBuilder.*@axe-core/playwright"
    - from: "tests/accessibility.spec.ts"
      to: "/test/cards/"
      via: "page.goto"
      pattern: "page\\.goto.*test/cards"
---

<objective>
Implement automated WCAG AAA contrast testing using axe-core for dark mode accessibility validation.

Purpose: Establish automated accessibility testing infrastructure to validate contrast ratios and prevent regressions in dark mode. This is foundational work that enables confident CSS changes in subsequent plans.

Output: New `tests/accessibility.spec.ts` with axe-core integration testing WCAG AAA compliance across test pages and Quran content pages in dark mode.
</objective>

<execution_context>
@/Users/daodilyas/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daodilyas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-dark-mode-polish/04-RESEARCH.md
@tests/cards.spec.ts
@src/styles/global.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install axe-core and create accessibility test file</name>
  <files>package.json, tests/accessibility.spec.ts</files>
  <action>
Install @axe-core/playwright as a dev dependency:
```bash
npm install -D @axe-core/playwright
```

Create `tests/accessibility.spec.ts` with the following structure:

1. Import statements:
   - `test, expect` from `@playwright/test`
   - `AxeBuilder` from `@axe-core/playwright`

2. Constants:
   - `BASE_URL = 'http://localhost:4321'`

3. Helper function to enable dark mode:
   ```typescript
   async function enableDarkMode(page) {
     await page.evaluate(() => {
       document.documentElement.setAttribute('data-theme', 'dark');
     });
     await page.waitForTimeout(300); // Allow CSS transitions
   }
   ```

4. Test describe block `'WCAG AAA Contrast - Dark Mode'` with tests for:
   - Test page `/test/cards/` - should have no WCAG AAA contrast violations
   - Test page `/test/components/` - should have no WCAG AAA contrast violations
   - Quran page `/surahs/001-al-fatiha/` - should pass contrast checks for Arabic text

5. Each test should:
   - Navigate to page, wait for networkidle
   - Enable dark mode via helper function
   - Run `new AxeBuilder({ page }).withTags(['wcag2aaa', 'wcag21aaa']).analyze()`
   - Assert `accessibilityScanResults.violations` equals empty array

6. Additional test describe block `'Color Contrast Rule Focus'` with:
   - Test specifically for color-contrast rule using `.withRules(['color-contrast'])`
   - Test Arabic text elements on Quran page

Note: Use the established patterns from existing tests/cards.spec.ts for page navigation and dark mode enabling.
  </action>
  <verify>
```bash
# Verify package installed
npm list @axe-core/playwright

# Verify test file exists
ls tests/accessibility.spec.ts

# TypeScript should compile without errors
npx tsc --noEmit tests/accessibility.spec.ts 2>/dev/null || echo "TS check (may fail without config, OK)"
```
  </verify>
  <done>
- @axe-core/playwright listed in package.json devDependencies
- tests/accessibility.spec.ts exists with AxeBuilder import and test structure
- Test file follows existing patterns from cards.spec.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Run accessibility tests and validate existing dark mode contrast</name>
  <files>tests/accessibility.spec.ts, package.json</files>
  <action>
Add npm script for accessibility tests:

In package.json scripts, add:
```json
"test:a11y": "npx playwright test tests/accessibility.spec.ts"
```

Run the accessibility tests:
```bash
npm run dev &  # Start dev server (if not already running)
npm run test:a11y
```

Expected outcomes:
1. If all tests PASS: Current dark mode contrast already meets WCAG AAA - document this
2. If tests FAIL: Note specific violations (element selectors, contrast ratios, suggested fixes)

For any failures, the test output will include:
- Failing element selectors
- Current contrast ratio
- Required contrast ratio
- Color values

If violations found, update global.css to fix them:
- Adjust `--text-tertiary` if needed (currently #a3a3a3 in dark mode)
- Ensure all text colors meet 7:1 minimum against their backgrounds

Research indicates current colors (#ffffff text on #0f0f0f background) already achieve 21:1, so expect PASS for primary text. Secondary/tertiary text may need adjustment.
  </action>
  <verify>
```bash
# Run tests
npm run test:a11y

# Check output for:
# - Number of tests passed
# - Any violation details
```
  </verify>
  <done>
- npm script test:a11y added to package.json
- Accessibility tests execute without runtime errors
- Results documented: either all pass (contrast already WCAG AAA) or specific violations identified and fixed
  </done>
</task>

<task type="auto">
  <name>Task 3: Add component-level contrast tests and edge cases</name>
  <files>tests/accessibility.spec.ts</files>
  <action>
Extend accessibility.spec.ts with additional tests:

1. Add test describe block `'Component Dark Mode Contrast'`:
   - Test progress indicators (ProgressBar, ProgressRing) for contrast
   - Test badges and level indicators
   - Test card hover states (run axe after hover)

2. Add test describe block `'Arabic Text Contrast'`:
   - Target specific Arabic text classes (.arabic, .arabic-lg, .arabic-xl)
   - Validate these elements pass color-contrast rule
   - Test SurahCard Arabic names specifically
   - Test LessonCard Arabic titles

3. Add test for light mode comparison:
   - Run same tests in light mode (no data-theme attribute)
   - Ensures light mode also passes WCAG AAA

4. Include edge case tests:
   - Test focus states (outline visibility)
   - Test disabled button contrast
   - Test placeholder text if any exists

Use pattern from research:
```typescript
const accessibilityScanResults = await new AxeBuilder({ page })
  .withRules(['color-contrast'])
  .include('.arabic') // Target specific elements
  .analyze();
```

Note: axe-core's include() method focuses validation on specific selectors while still checking their context.
  </action>
  <verify>
```bash
# Run full accessibility test suite
npm run test:a11y

# Should see all tests pass with output like:
# X passed (N.Ns)
```
  </verify>
  <done>
- tests/accessibility.spec.ts contains comprehensive dark mode contrast tests
- Component-level tests for progress, badges, cards
- Arabic text-specific contrast validation
- All tests pass or violations documented with fixes applied
  </done>
</task>

</tasks>

<verification>
Run complete test suite to verify accessibility infrastructure:

```bash
# Start dev server
npm run dev &

# Run accessibility tests
npm run test:a11y

# Run existing card tests to ensure no regressions
npx playwright test tests/cards.spec.ts

# Combined run
npx playwright test tests/
```

Expected: All tests pass, confirming WCAG AAA contrast compliance in dark mode.
</verification>

<success_criteria>
1. @axe-core/playwright installed and functional
2. tests/accessibility.spec.ts created with WCAG AAA validation
3. npm script `test:a11y` works correctly
4. All test pages pass WCAG AAA contrast in dark mode
5. Arabic text elements pass contrast validation
6. No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/04-dark-mode-polish/04-01-SUMMARY.md`
</output>
